<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>HJNF</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
      font-family: 'Noto Sans KR', 'Montserrat', Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeInBg 1.2s;
    }
    @keyframes fadeInBg {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .container {
      max-width: 480px;
      width: 100%;
      margin: 40px auto;
      background: rgba(255,255,255,0.98);
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.13);
      padding: 40px 32px 32px 32px;
      position: relative;
      transition: box-shadow 0.3s;
      animation: fadeInCard 1.1s;
    }
    @keyframes fadeInCard {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    h2, h3 {
      color: #009688;
      margin-top: 0;
      font-family: 'Montserrat', 'Noto Sans KR', Arial, sans-serif;
      letter-spacing: 1px;
      font-weight: 700;
      text-shadow: 0 2px 8px rgba(0,150,136,0.08);
    }
    input, textarea, button {
      font-family: inherit;
      font-size: 15px;
      border-radius: 8px;
      border: 1px solid #ddd;
      margin-bottom: 12px;
      padding: 10px;
      outline: none;
      box-sizing: border-box;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus, textarea:focus {
      border-color: #009688;
      box-shadow: 0 0 0 2px #b2dfdb44;
    }
    button {
      background: linear-gradient(90deg, #009688 60%, #26c6da 100%);
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
      margin-right: 6px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0,150,136,0.08);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    button:hover {
      background: linear-gradient(90deg, #00796b 60%, #009688 100%);
      box-shadow: 0 4px 16px rgba(0,150,136,0.13);
    }
    #formContainer {
      margin-top: 24px;
      animation: fadeInForm 0.8s;
    }
    @keyframes fadeInForm {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    #result {
      margin-top: 12px;
      color: #e91e63;
      font-weight: bold;
      text-align: center;
      font-size: 16px;
      letter-spacing: 0.5px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      background: #fafbfc;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 12px rgba(0,150,136,0.07);
      font-size: 15px;
    }
    th, td {
      padding: 12px 10px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    th {
      background: linear-gradient(90deg, #e0f2f1 60%, #b2ebf2 100%);
      color: #009688;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    tr:last-child td {
      border-bottom: none;
    }
    #showSignup, #showLogin, #logoutBtn, #showCommunity {
      margin: 8px 4px 0 0;
      padding: 10px 22px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(90deg, #009688 60%, #26c6da 100%);
      color: #fff;
      box-shadow: 0 2px 8px rgba(0,150,136,0.08);
      font-weight: 600;
      letter-spacing: 0.5px;
      transition: background 0.2s, box-shadow 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    #showSignup:hover, #showLogin:hover, #logoutBtn:hover, #showCommunity:hover {
      background: linear-gradient(90deg, #00796b 60%, #009688 100%);
      box-shadow: 0 4px 16px rgba(0,150,136,0.13);
    }
    #backToServer {
      background: linear-gradient(90deg, #e0f2f1 60%, #b2ebf2 100%);
      color: #009688;
      border: none;
      font-weight: 700;
      margin-bottom: 16px;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: 0 2px 8px rgba(0,150,136,0.08);
      letter-spacing: 0.5px;
    }
    #backToServer:hover {
      background: linear-gradient(90deg, #b2dfdb 60%, #e0f2f1 100%);
      box-shadow: 0 4px 16px rgba(0,150,136,0.13);
    }
    .post-nickname {
      color: #009688;
      font-size: 14px;
      font-weight: 600;
      margin-left: 8px;
      letter-spacing: 0.3px;
    }
    .post-content {
      color: #444;
      margin: 6px 0 8px 0;
      display: block;
      font-size: 15px;
      line-height: 1.6;
    }
    .post-date {
      font-size: 12px;
      color: #aaa;
      margin-left: 2px;
    }
    /* 아이콘 버튼 예시 (FontAwesome 등 사용 가능) */
    .icon-btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="text-align:center; margin-bottom:24px;">
      <span style="font-size:2.2rem; font-weight:900; color:#009688; letter-spacing:2px; font-family:'Montserrat','Noto Sans KR',sans-serif; text-shadow:0 2px 12px #b2ebf2;">HJNF</span>
      <div style="font-size:1.1rem; color:#555; margin-top:4px; font-weight:500;">Roblox 서버 & 커뮤니티</div>
    </div>
    <button id="showSignup">회원가입</button>
    <button id="showLogin">로그인</button>
    <button id="logoutBtn" style="display:none">로그아웃</button>
    <button id="showCommunity">커뮤니티</button>
    <div id="formContainer">
      <!-- 폼이 여기에 동적으로 표시됨 -->
    </div>
    <div id="result"></div>
  </div>
  <script>
    // Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyDKxcKXSmKF6LAEnFzF387ZN4wC8iRz8mg",
      authDomain: "rugged-night-396106.firebaseapp.com",
      databaseURL: "https://rugged-night-396106-default-rtdb.firebaseio.com",
      projectId: "rugged-night-396106",
      storageBucket: "rugged-night-396106.appspot.com",
      messagingSenderId: "388578786746",
      appId: "1:388578786746:web:c50051b71731c153f6b183",
      measurementId: "G-SRLCD2LZT8"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();

    // 폼 전환 함수
    function showSignupForm() {
      document.getElementById('formContainer').innerHTML = `
        <h2>회원가입</h2>
        <form id="signupForm">
          <input type="email" id="email" placeholder="이메일" required><br>
          <input type="password" id="password" placeholder="비밀번호" required><br>
          <input type="text" id="roblox" placeholder="로블록스 닉네임" required><br>
          <button type="submit">회원가입</button>
        </form>
      `;
      document.getElementById('result').innerText = "";
      document.getElementById('signupForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const roblox = document.getElementById('roblox').value;
        auth.createUserWithEmailAndPassword(email, password)
          .then((userCredential) => {
            const user = userCredential.user;
            db.ref('users/' + user.uid).set({
              email: email,
              robloxNickname: roblox
            });
            document.getElementById('result').innerText = "회원가입 성공!";
          })
          .catch((error) => {
            document.getElementById('result').innerText = "오류: " + error.message;
          });
      });
    }

    // 관리자 UID
    const ADMIN_UID = "VDDnepBDUtMqoVv4z2pxIAoolV93";

    function showLoginForm() {
      document.getElementById('formContainer').innerHTML = `
        <h2>로그인</h2>
        <form id="loginForm">
          <input type="email" id="loginEmail" placeholder="이메일" required><br>
          <input type="password" id="loginPassword" placeholder="비밀번호" required><br>
          <button type="submit">로그인</button>
        </form>
      `;
      document.getElementById('result').innerText = "";
      document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        auth.signInWithEmailAndPassword(email, password)
          .then((userCredential) => {
            document.getElementById('result').innerText = "로그인 성공!";
            if (userCredential.user.uid === ADMIN_UID) {
              showAdminPanel();
            } else {
              // 로그인 후 서버 정보 확인
              db.ref('users/' + userCredential.user.uid + '/server').once('value').then(snap => {
                const server = snap.val();
                if (server && server.status) {
                  showServerStatus(userCredential.user.uid, server);
                } else {
                  showServerButton(userCredential.user.uid);
                }
              });
            }
          })
          .catch((error) => {
            document.getElementById('result').innerText = "오류: " + error.message;
          });
      });
    }

    // 서버 상태 및 시간초 표시 함수
    function showServerStatus(uid, server) {
      // 로블록스 닉네임 가져오기
      db.ref('users/' + uid + '/robloxNickname').once('value').then(snap => {
        const nickname = snap.val() || '';
        let statusText = '';
        let extraBtn = '';
        // 상태 한국어 변환
        let statusKor = '';
        switch (server.status) {
          case 'pending': statusKor = '대기중'; break;
          case 'approved': statusKor = '운영중'; break;
          case 'stopped': statusKor = '정지됨'; break;
          case 'paused': statusKor = '일시정지'; break;
          default: statusKor = server.status;
        }
        if (server.status === 'stopped') {
          statusText = '<span style="color:red">정지된 서버</span>';
        } else if (server.status === 'paused') {
          statusText = '<span style="color:orange">일시정지</span>';
          extraBtn = '<button id="resumeServerBtn">다시 시작</button>';
        } else {
          statusText = `<span id="serverStatusText">${statusKor}</span>`;
        }
        document.getElementById('formContainer').innerHTML = `
          <h2>내 서버 정보</h2>
          <div>로블록스 닉네임: <b>${nickname}</b></div>
          <div>상태: ${statusText}</div>
          <div>요청 시간: ${server.requestedAt ? new Date(server.requestedAt).toLocaleString() : ''}</div>
          ${server.url ? `<div>서버 주소: <a href="${server.url}" target="_blank">${server.url}</a></div>` : ''}
          ${extraBtn}
        `;
        // 서버 상태 실시간 업데이트
        db.ref('users/' + uid + '/server/status').on('value', function(snapshot) {
          const val = snapshot.val();
          // 상태 한국어 변환
          let statusKor = '';
          switch (val) {
            case 'pending': statusKor = '대기중'; break;
            case 'approved': statusKor = '운영중'; break;
            case 'stopped': statusKor = '정지됨'; break;
            case 'paused': statusKor = '일시정지'; break;
            default: statusKor = val;
          }
          if (val === 'stopped') {
            document.getElementById('serverStatusText').innerHTML = '<span style="color:red">정지된 서버</span>';
          } else if (val === 'paused') {
            document.getElementById('serverStatusText').innerHTML = '<span style="color:orange">일시정지</span>';
            if (!document.getElementById('resumeServerBtn')) {
              document.getElementById('formContainer').innerHTML += '<button id="resumeServerBtn">다시 시작</button>';
            }
          } else {
            document.getElementById('serverStatusText').innerText = statusKor;
          }
        });
        // 일시정지 상태에서 다시 시작 버튼
        if (server.status === 'paused') {
          document.getElementById('resumeServerBtn').onclick = function() {
            db.ref('serverRequests/' + uid + '/status').set('approved');
            db.ref('users/' + uid + '/server/status').set('approved');
          };
        }
      });
    }

    // 관리자 패널: 모든 서버 요청 보기
    function showAdminPanel() {
      document.getElementById('formContainer').innerHTML = `
        <h2>관리자 서버 요청 기록</h2>
        <div id="adminRequests"></div>
      `;
      // 모든 서버 요청 실시간 표시
      db.ref('serverRequests').on('value', function(snapshot) {
        const requests = snapshot.val();
        let html = '<table border="1" style="border-collapse:collapse; width:100%">';
        html += '<tr><th>로블닉네임</th><th>서버 상태</th><th>요청시간</th><th>관리</th></tr>';
        for (const uid in requests) {
          const req = requests[uid];
          // 상태 한국어 변환
          let statusKor = '';
          switch (req.status) {
            case 'pending': statusKor = '대기중'; break;
            case 'approved': statusKor = '운영중'; break;
            case 'stopped': statusKor = '정지됨'; break;
            case 'paused': statusKor = '일시정지'; break;
            default: statusKor = req.status;
          }
          html += `<tr id="row-${uid}"><td id="nick-${uid}">조회중...</td>`;
          html += `<td>${statusKor}</td>`;
          html += `<td>${new Date(req.requestedAt).toLocaleString()}</td>`;
          html += `<td>`;
          if (req.status === 'pending') {
            html += `<input type="text" id="serverUrl-${uid}" placeholder="서버 주소 입력" style="width:120px;">`;
            html += `<button onclick="approveServerWithUrl('${uid}')">승인</button>`;
          }
          html += `<button onclick="stopServer('${uid}')">정지</button>`;
          html += `<button onclick="pauseServer('${uid}')">일시정지</button>`;
          html += `<button onclick="deleteServer('${uid}')">삭제</button>`;
          html += `</td></tr>`;
          // 닉네임 비동기 표시
          db.ref('users/' + uid + '/robloxNickname').once('value').then(snap => {
            const nickname = snap.val() || '(없음)';
            document.getElementById('nick-' + uid).innerText = nickname;
          });
        }
        html += '</table>';
        document.getElementById('adminRequests').innerHTML = html;
      });
    }

    // 서버 관리 함수들 (window에 등록)
    // 서버 승인(주소 포함)
    window.approveServerWithUrl = function(uid) {
      const urlInput = document.getElementById('serverUrl-' + uid);
      const serverUrl = urlInput ? urlInput.value.trim() : '';
      db.ref('serverRequests/' + uid + '/status').set('approved');
      db.ref('users/' + uid + '/server/status').set('approved');
      db.ref('users/' + uid + '/server/url').set(serverUrl);
    }
    window.stopServer = function(uid) {
      db.ref('serverRequests/' + uid + '/status').set('stopped');
      db.ref('users/' + uid + '/server/status').set('stopped');
    }
    window.pauseServer = function(uid) {
      db.ref('serverRequests/' + uid + '/status').set('paused');
      db.ref('users/' + uid + '/server/status').set('paused');
    }
    window.deleteServer = function(uid) {
      db.ref('serverRequests/' + uid).remove();
      db.ref('users/' + uid + '/server').remove();
    }

    document.getElementById('showSignup').addEventListener('click', showSignupForm);
    document.getElementById('showLogin').addEventListener('click', showLoginForm);
    document.getElementById('logoutBtn').addEventListener('click', function() {
      auth.signOut();
    });
  document.getElementById('showCommunity').addEventListener('click', showCommunity);
    // 커뮤니티(게시판) 기능
    function showCommunity() {
      let formHtml = '';
      if (auth.currentUser) {
        formHtml = `
          <form id="postForm">
            <input type="text" id="postTitle" placeholder="제목" required style="width:200px"><br>
            <textarea id="postContent" placeholder="내용" required style="width:300px;height:80px"></textarea><br>
            <button type="submit">글 작성</button>
          </form>
        `;
      } else {
        formHtml = `<div style="color:red;margin-bottom:10px">커뮤니티 글 작성은 로그인 후 이용 가능합니다.</div>`;
      }
      document.getElementById('formContainer').innerHTML = `
        <h2>커뮤니티 게시판</h2>
        <button id="backToServer" style="margin-bottom:10px">서버 관리로 돌아가기</button>
        ${formHtml}
        <div id="postList"></div>
      `;
      document.getElementById('backToServer').onclick = function() {
        if (auth.currentUser) {
          if (auth.currentUser.uid === ADMIN_UID) {
            showAdminPanel();
          } else {
            db.ref('users/' + auth.currentUser.uid + '/server').once('value').then(snap => {
              const server = snap.val();
              if (server && server.status) {
                showServerStatus(auth.currentUser.uid, server);
              } else {
                showServerButton(auth.currentUser.uid);
              }
            });
          }
        } else {
          showSignupForm();
        }
      };
      loadPosts();
      if (auth.currentUser) {
        document.getElementById('postForm').addEventListener('submit', function(e) {
          e.preventDefault();
          const title = document.getElementById('postTitle').value.trim();
          const content = document.getElementById('postContent').value.trim();
          if (!title || !content) return;
          let nickname = '';
          db.ref('users/' + auth.currentUser.uid + '/robloxNickname').once('value').then(snap => {
            nickname = snap.val() || '';
            const postData = {
              title,
              content,
              nickname,
              createdAt: Date.now()
            };
            db.ref('community/posts').push(postData).then(() => {
              document.getElementById('postTitle').value = '';
              document.getElementById('postContent').value = '';
            });
          });
        });
      }
    }

    function loadPosts() {
      db.ref('community/posts').orderByChild('createdAt').limitToLast(30).on('value', function(snapshot) {
        const posts = snapshot.val();
        let html = '<h3>게시글 목록</h3>';
        if (!posts) {
          html += '<div>아직 글이 없습니다.</div>';
        } else {
          html += '<ul style="padding-left:0">';
          // 최신글이 위로
          const arr = Object.entries(posts).sort((a, b) => b[1].createdAt - a[1].createdAt);
          arr.forEach(([key, post]) => {
            html += `<li style="margin-bottom:10px;list-style:none;border-bottom:1px solid #eee;padding-bottom:8px">
              <b>${post.title}</b> <span style="color:#009688;font-size:13px">(${post.nickname || '익명'})</span><br>
              <span style="color:#555">${post.content}</span><br>
              <span style="font-size:12px;color:#aaa">${new Date(post.createdAt).toLocaleString()}</span>
              ${auth.currentUser && auth.currentUser.uid === ADMIN_UID ? `<button onclick="deletePost('${key}')" style="margin-left:10px;color:red">삭제</button>` : ''}
            </li>`;
          });
          html += '</ul>';
        }
        document.getElementById('postList').innerHTML = html;
      });
    }

    // 관리자 글 삭제 함수
    window.deletePost = function(key) {
      if (auth.currentUser && auth.currentUser.uid === ADMIN_UID) {
        db.ref('community/posts/' + key).remove();
      }
    }

    // 자동 로그인 처리
    auth.onAuthStateChanged(function(user) {
      if (user) {
        document.getElementById('showSignup').style.display = 'none';
        document.getElementById('showLogin').style.display = 'none';
        document.getElementById('logoutBtn').style.display = '';
        if (user.uid === ADMIN_UID) {
          showAdminPanel();
        } else {
          db.ref('users/' + user.uid + '/server').once('value').then(snap => {
            const server = snap.val();
            if (server && server.status) {
              showServerStatus(user.uid, server);
            } else {
              showServerButton(user.uid);
            }
          });
        }
      } else {
        document.getElementById('showSignup').style.display = '';
        document.getElementById('showLogin').style.display = '';
        document.getElementById('logoutBtn').style.display = 'none';
        showSignupForm();
      }
    });

    // 서버 생성 버튼 및 서버 요청/타이머 처리
    function showServerButton(uid) {
      // 서버가 이미 있으면 생성 버튼 숨김
      db.ref('users/' + uid + '/server').once('value').then(snap => {
        if (snap.exists()) {
          showServerStatus(uid, snap.val());
          return;
        }
        // 로블록스 닉네임 가져오기
        db.ref('users/' + uid + '/robloxNickname').once('value').then(nickSnap => {
          const nickname = nickSnap.val() || '';
          document.getElementById('formContainer').innerHTML = `
            <h2>서버 생성</h2>
            <div>로블록스 닉네임: <b>${nickname}</b></div>
            <button id="createServerBtn">서버 생성</button>
            <div id="serverStatus"></div>
            <div id="serverTimer"></div>
          `;
          document.getElementById('createServerBtn').addEventListener('click', function() {
            // 서버 요청을 DB에 저장
            const now = Date.now();
            db.ref('serverRequests/' + uid).set({
              status: 'pending',
              requestedAt: now
            });
            // 계정에 서버 정보 저장 (초기값)
            const serverData = {
              status: 'pending',
              requestedAt: now,
              seconds: 0
            };
            db.ref('users/' + uid + '/server').set(serverData).then(() => {
              // 서버 요청을 보냈다고만 표시
              document.getElementById('formContainer').innerHTML = `
                <h2>서버 요청</h2>
                <div>서버 생성 요청을 보냈습니다.<br>관리자의 승인을 기다려주세요.</div>
              `;
            });
            // 서버 승인 대기 및 타이머 표시
            waitForServerApproval(uid);
          });
        });
      });
    }

    function waitForServerApproval(uid) {
      // 실시간으로 서버 승인 상태 확인
      db.ref('serverRequests/' + uid + '/status').on('value', function(snapshot) {
        const status = snapshot.val();
        if (status === 'approved') {
          // 서버 정보와 시간초 표시
          db.ref('users/' + uid + '/server').once('value').then(snap => {
            showServerStatus(uid, snap.val());
          });
          startServerTimer(uid);
        }
      });
    }

    // 시간초 기능 제거됨
  </script>
</body>
</html>
