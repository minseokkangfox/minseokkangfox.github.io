<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>CYBER TYPE: PROTOCOL</title>
    <style>
        /* Font */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Do+Hyeon&display=swap');

        :root {
            --bg-dark: #0a0a12;
            --panel-bg: rgba(16, 20, 36, 0.9);
            --neon-blue: #00f3ff;
            --neon-pink: #ff0055;
            --neon-green: #0aff60;
            --neon-yellow: #ffd700;
        }

        * {
            box-sizing: border-box;
            user-select: none;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background-color: var(--bg-dark);
            background-image:
                linear-gradient(rgba(0, 243, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
            background-position: center;
            animation: backgroundScroll 10s linear infinite;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Do Hyeon', sans-serif;
            color: white;
            overflow: hidden;
        }

        @keyframes backgroundScroll {
            from {
                background-position: 0 0;
            }

            to {
                background-position: 0 400px;
            }
        }

        .game-frame {
            position: relative;
            width: 900px;
            padding: 40px;
            background: var(--panel-bg);
            border: 3px solid var(--neon-blue);
            box-shadow: 0 0 20px var(--neon-blue), inset 0 0 30px rgba(0, 243, 255, 0.2);
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        .game-frame::before,
        .game-frame::after {
            content: '';
            position: absolute;
            width: 15px;
            height: 15px;
            background: var(--neon-blue);
            box-shadow: 0 0 10px var(--neon-blue);
            border-radius: 50%;
        }

        .game-frame::before {
            top: -7px;
            left: -7px;
        }

        .game-frame::after {
            bottom: -7px;
            right: -7px;
        }

        /* UI Elements */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 20px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--neon-blue);
            font-family: 'Orbitron';
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--neon-blue);
        }

        .login-btn {
            background: transparent;
            border: 2px solid var(--neon-green);
            color: var(--neon-green);
            padding: 5px 15px;
            cursor: pointer;
            font-family: 'Orbitron';
            transition: 0.3s;
        }

        .login-btn:hover {
            background: var(--neon-green);
            color: black;
            box-shadow: 0 0 15px var(--neon-green);
        }

        .mission-select,
        .mode-select {
            margin-bottom: 30px;
            z-index: 20;
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .mission-select {
            display: flex;
        }

        .mode-select {
            display: none;
        }

        .mission-btn,
        .mode-btn {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--neon-pink);
            color: var(--neon-pink);
            padding: 12px 25px;
            font-size: 1.3rem;
            cursor: pointer;
            font-family: 'Orbitron', 'Do Hyeon', sans-serif;
            transition: all 0.3s;
            clip-path: polygon(10% 0, 100% 0, 90% 100%, 0% 100%);
        }

        .mode-btn {
            border-color: var(--neon-blue);
            color: var(--neon-blue);
        }

        .mission-btn.active,
        .mission-btn:hover,
        .mode-btn.active,
        .mode-btn:hover {
            background: var(--neon-pink);
            color: var(--bg-dark);
            box-shadow: 0 0 25px var(--neon-pink);
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }

        .mode-btn.active,
        .mode-btn:hover {
            background: var(--neon-blue);
            box-shadow: 0 0 25px var(--neon-blue);
        }

        .hud-panel {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--neon-blue);
            border-radius: 5px;
            margin-bottom: 25px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            color: var(--neon-blue);
            letter-spacing: 1px;
        }

        .hud-panel b {
            color: #fff;
            font-size: 1.4rem;
            text-shadow: 0 0 5px var(--neon-blue);
        }

        .combo-display {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--neon-pink);
            text-shadow: 2px 2px 0 #000, 0 0 20px var(--neon-pink);
            opacity: 0;
            transition: transform 0.1s;
        }

        .combo-display.active {
            opacity: 1;
            transform: scale(1.1) skew(-5deg);
        }

        .terminal-screen {
            position: relative;
            background: #001a00;
            border: 3px solid var(--neon-green);
            box-shadow: inset 0 0 30px rgba(10, 255, 96, 0.3);
            padding: 30px 10px;
            margin: 20px 0;
            min-height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .word-box {
            font-size: 3.8rem;
            color: var(--neon-green);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8), 0 0 15px var(--neon-green);
            line-height: 1.2;
            word-break: keep-all;
            z-index: 2;
        }

        .terminal-screen::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            z-index: 1;
            pointer-events: none;
        }

        .input-container {
            position: relative;
            margin-top: 30px;
        }

        .input-field {
            width: 100%;
            padding: 15px;
            font-size: 2.2rem;
            background: rgba(0, 0, 0, 0.5);
            border: 3px solid var(--neon-yellow);
            color: #fff;
            text-align: center;
            outline: none;
            font-family: 'Do Hyeon', sans-serif;
            box-shadow: 0 0 15px var(--neon-yellow);
            clip-path: polygon(2% 0, 98% 0, 100% 100%, 0% 100%);
            transition: all 0.1s;
        }

        .input-field:focus {
            box-shadow: 0 0 40px var(--neon-yellow), inset 0 0 20px var(--neon-yellow);
        }

        .power-gauge {
            width: 100%;
            height: 15px;
            background: #222;
            margin-top: 25px;
            border: 2px solid #444;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 10px #000;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-green));
            width: 0%;
            box-shadow: 0 0 20px var(--neon-green);
            transition: width 0.2s cubic-bezier(0.1, 0.7, 1.0, 0.1);
        }

        /* PVP HUD */
        .pvp-hud {
            display: none;
            justify-content: space-between;
            margin-top: 10px;
            color: var(--neon-pink);
            font-family: 'Orbitron', 'Do Hyeon', sans-serif;
        }

        .opponent-gauge {
            width: 100%;
            height: 10px;
            background: #222;
            border: 1px solid var(--neon-pink);
            margin-top: 5px;
            position: relative;
        }

        .opponent-fill {
            height: 100%;
            background: var(--neon-pink);
            width: 0%;
            transition: width 0.5s;
        }

        .keyboard-panel {
            margin-top: 40px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.4);
            border-top: 2px solid var(--neon-blue);
            display: flex;
            flex-direction: column;
            gap: 6px;
            align-items: center;
            perspective: 800px;
        }

        .row {
            display: flex;
            gap: 6px;
        }

        .key {
            width: 50px;
            height: 50px;
            background: #1a1a1a;
            border: 2px solid #333;
            color: rgba(255, 255, 255, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 5px 0 #000;
            transform-origin: bottom;
            transition: all 0.05s;
        }

        .key.space {
            width: 300px;
            font-size: 1rem;
        }

        .key.pressed {
            transform: translateY(5px) rotateX(10deg);
            border-color: var(--neon-pink);
            background: var(--neon-pink);
            color: #fff;
            box-shadow: 0 0 25px var(--neon-pink);
            text-shadow: 0 0 5px #fff;
        }

        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            pointer-events: none;
            box-shadow: 0 0 10px currentColor;
            animation: explode 0.8s forwards cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes explode {
            to {
                transform: translate(var(--mx), var(--my)) scale(0);
                opacity: 0;
            }
        }

        .shake-screen {
            animation: screenShake 0.2s ease-in-out;
        }

        @keyframes screenShake {

            0%,
            100% {
                transform: translate(0, 0);
            }

            20% {
                transform: translate(-8px, 8px) rotate(-1deg);
            }

            40% {
                transform: translate(8px, -8px) rotate(1deg);
            }

            60% {
                transform: translate(-5px, 0px);
            }
        }

        .shake-input {
            animation: inputShake 0.3s;
            border-color: red !important;
            box-shadow: 0 0 40px red !important;
        }

        @keyframes inputShake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-20px);
            }

            75% {
                transform: translateX(20px);
            }
        }
    </style>
</head>

<body>
    <audio id="bg-music" preload="auto"></audio>
    <h1
        style="font-family: 'Orbitron'; color: var(--neon-blue); text-shadow:0 0 20px var(--neon-blue); margin-bottom:10px;">
        CYBER TYPE PROTOCOL</h1>
    <div class="game-frame">
        <div class="top-bar">
            <div class="user-profile" id="user-profile" style="display:none;">
                <img id="user-avatar" class="user-avatar" src="" alt="User">
                <span id="user-name">PLAYER</span>
            </div>
            <button id="login-btn" class="login-btn">로그인</button>
        </div>

        <div class="mission-select">
            <button class="mission-btn active" onclick="setMission('word')">단어 미션</button>
            <button class="mission-btn" onclick="setMission('sentence')">문장 미션</button>
            <button class="mission-btn" onclick="setMission('custom')">커스텀 미션</button>
            <button class="mission-btn" onclick="setMission('pvp')">PVP 대결</button>
        </div>
        <div class="mode-select">
            <button class="mode-btn active" onclick="setMode('word')">단어 미션</button>
            <button class="mode-btn" onclick="setMode('sentence')">문장 미션</button>
        </div>

        <div class="hud-panel">
            <span>점수: <b id="score">0</b></span>
            <span>레벨: <b id="level">1</b></span>
            <span>남은 개수: <b id="remaining">0</b></span>
            <div id="combo-box" class="combo-display">콤보 x0</div>
            <span>정확도: <b id="accuracy">100%</b></span>
        </div>

        <div class="pvp-hud" id="pvp-hud">
            <span>상대방 진행도</span>
            <div class="opponent-gauge">
                <div class="opponent-fill" id="opponent-fill"></div>
            </div>
            <div id="pvp-status">상대방 대기 중...</div>
        </div>

        <div class="terminal-screen">
            <div class="word-box" id="word-display">미션을 선택하고 엔터를 누르세요</div>
        </div>
        <div class="input-container">
            <input type="text" class="input-field" id="input-field" placeholder="엔터를 눌러 시작" autocomplete="off">
        </div>
        <div class="power-gauge">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div class="keyboard-panel">
            <div class="keyboard" id="keyboard"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, update, get, child, push, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDc82XuNoS2OGi2GucojluXWqTFHVQx7wk",
            authDomain: "mttq-8cd9f.firebaseapp.com",
            databaseURL: "https://mttq-8cd9f-default-rtdb.firebaseio.com",
            projectId: "mttq-8cd9f",
            storageBucket: "mttq-8cd9f.firebasestorage.app",
            messagingSenderId: "752583840572",
            appId: "1:752583840572:web:8ad63d28d669c99f0b8439",
            measurementId: "G-9CWT3HQTXC"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let pvpRoomId = null;
        let isPvp = false;
        let myRole = null; // 'player1' or 'player2'

        // Auth UI
        const loginBtn = document.getElementById('login-btn');
        const userProfile = document.getElementById('user-profile');
        const userName = document.getElementById('user-name');
        const userAvatar = document.getElementById('user-avatar');

        loginBtn.addEventListener('click', () => {
            if (currentUser) {
                signOut(auth);
            } else {
                signInWithPopup(auth, provider).catch(console.error);
            }
        });

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                loginBtn.innerText = "로그아웃";
                userProfile.style.display = "flex";
                userName.innerText = user.displayName;
                userAvatar.src = user.photoURL;
                loadUserData(user.uid);
            } else {
                loginBtn.innerText = "로그인";
                userProfile.style.display = "none";
                score = 0; level = 1;
                updateHUD();
            }
        });

        function saveUserData() {
            if (!currentUser) return;
            update(ref(db, 'users/' + currentUser.uid), {
                score: score,
                level: level
            });
        }

        function loadUserData(uid) {
            get(child(ref(db), 'users/' + uid)).then((snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    score = data.score || 0;
                    level = data.level || 1;
                    updateHUD();
                }
            });
        }

        // PVP Logic
        window.startPVP = function () {
            if (!currentUser) { alert("먼저 로그인해주세요!"); return; }
            isPvp = true;
            document.getElementById('pvp-hud').style.display = 'block';
            document.getElementById('pvp-status').innerText = "상대방 찾는 중...";

            // Matchmaking: Find a room with status 'waiting'
            get(ref(db, 'matches')).then((snapshot) => {
                let foundRoom = null;
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const room = childSnapshot.val();
                        if (room.status === 'waiting' && !room.player2) {
                            foundRoom = childSnapshot.key;
                        }
                    });
                }

                if (foundRoom) {
                    // Join existing room
                    pvpRoomId = foundRoom;
                    myRole = 'player2';
                    const updates = {};
                    updates[`matches/${pvpRoomId}/player2`] = {
                        uid: currentUser.uid,
                        name: currentUser.displayName,
                        progress: 0
                    };
                    updates[`matches/${pvpRoomId}/status`] = 'playing';
                    update(ref(db), updates).then(() => {
                        setupDisconnect();
                        listenToRoom();
                    });
                } else {
                    // Create new room
                    const newRoomRef = push(ref(db, 'matches'));
                    pvpRoomId = newRoomRef.key;
                    myRole = 'player1';
                    set(newRoomRef, {
                        player1: {
                            uid: currentUser.uid,
                            name: currentUser.displayName,
                            progress: 0
                        },
                        status: 'waiting'
                    }).then(() => {
                        setupDisconnect();
                        listenToRoom();
                    });
                }
            });
        };

        function setupDisconnect() {
            // Remove my player entry on disconnect
            onDisconnect(ref(db, `matches/${pvpRoomId}/${myRole}`)).remove();
            // If I am host (player1), maybe remove the whole room? Or handle in listener.
            // For simplicity, if any player disconnects, the room state becomes invalid.
        }

        function listenToRoom() {
            onValue(ref(db, `matches/${pvpRoomId}`), (snapshot) => {
                const data = snapshot.val();
                if (!data) return; // Room deleted

                // Check for disconnection
                if (data.status === 'playing') {
                    if (!data.player1 || !data.player2) {
                        endGame(true); // Win by default
                        document.getElementById('word-display').innerText = "상대방 연결 끊김! 승리!";
                        // Clean up room
                        remove(ref(db, `matches/${pvpRoomId}`));
                        return;
                    }
                }

                if (data.status === 'playing' && !isPlaying) {
                    // Game Start
                    document.getElementById('pvp-status').innerText = "VS " + (myRole === 'player1' ? data.player2.name : data.player1.name);
                    initGame();
                }

                // Update Opponent Gauge
                const opponent = myRole === 'player1' ? data.player2 : data.player1;
                if (opponent) {
                    const oppProgress = opponent.progress || 0;
                    const fill = Math.min((oppProgress / 30) * 100, 100); // Target 30 words
                    document.getElementById('opponent-fill').style.width = fill + '%';

                    if (oppProgress >= 30) {
                        endGame(false); // Lose
                        document.getElementById('word-display').innerText = "패배!";
                        // Clean up room if I lost (game over)
                        // remove(ref(db, `matches/${pvpRoomId}`)); // Let winner clean up or auto
                    }
                }
            });
        }

        function updatePVPProgress() {
            if (!isPvp || !pvpRoomId || !currentUser) return;

            update(ref(db, `matches/${pvpRoomId}/${myRole}`), { progress: correct });

            if (correct >= 30) {
                endGame(true); // Win
                document.getElementById('word-display').innerText = "승리!";
                // Clean up room
                setTimeout(() => {
                    remove(ref(db, `matches/${pvpRoomId}`));
                }, 3000);
            }
        }

        function endPVP() {
            isPvp = false;
            pvpRoomId = null;
            myRole = null;
            document.getElementById('pvp-hud').style.display = 'none';
        }

        // --- Game Logic (Existing + Modified) ---
        const wordList = ["사이버", "네온", "해킹", "프로토콜", "매트릭스", "가상현실", "인공지능", "알고리즘", "데이터", "서버", "광속", "질주", "폭발", "레이저", "플라즈마", "엔진", "부스터", "오버드라이브", "시스템", "보안", "방화벽", "바이러스", "백신", "코드", "디버깅", "컴파일", "네트워크", "접속", "차단", "승인", "갤럭시", "유니버스", "행성", "궤도", "위성", "블랙홀", "초신성", "빅뱅", "차원", "포털"];
        const sentenceList = ["새로운 시스템에 접속합니다.", "보안 프로토콜이 해제되었습니다.", "데이터 전송 속도가 임계점을 넘었습니다.", "알 수 없는 오류가 발생했습니다.", "모든 목표물을 제거하십시오.", "가상 현실 세계에 오신 것을 환영합니다.", "인공지능이 스스로 진화하고 있습니다.", "방화벽을 돌파하는 데 성공했습니다.", "긴급 상황! 시스템이 다운됩니다.", "마지막 미션을 완수하십시오."];
        const keyMap = { KeyQ: 'ㅂ', KeyW: 'ㅈ', KeyE: 'ㄷ', KeyR: 'ㄱ', KeyT: 'ㅅ', KeyY: 'ㅛ', KeyU: 'ㅕ', KeyI: 'ㅑ', KeyO: 'ㅐ', KeyP: 'ㅔ', KeyA: 'ㅁ', KeyS: 'ㄴ', KeyD: 'ㅇ', KeyF: 'ㄹ', KeyG: 'ㅎ', KeyH: 'ㅗ', KeyJ: 'ㅓ', KeyK: 'ㅏ', KeyL: 'ㅣ', KeyZ: 'ㅋ', KeyX: 'ㅌ', KeyC: 'ㅊ', KeyV: 'ㅍ', KeyB: 'ㅠ', KeyN: 'ㅜ', KeyM: 'ㅡ' };
        const keyboardLayout = [
            ['KeyQ', 'KeyW', 'KeyE', 'KeyR', 'KeyT', 'KeyY', 'KeyU', 'KeyI', 'KeyO', 'KeyP'],
            ['KeyA', 'KeyS', 'KeyD', 'KeyF', 'KeyG', 'KeyH', 'KeyJ', 'KeyK', 'KeyL'],
            ['KeyZ', 'KeyX', 'KeyC', 'KeyV', 'KeyB', 'KeyN', 'KeyM']
        ];

        const keyboardDiv = document.getElementById('keyboard');
        function createKeyboard() {
            keyboardDiv.innerHTML = '';
            keyboardLayout.forEach(row => {
                const rowDiv = document.createElement('div'); rowDiv.className = 'row';
                row.forEach(k => { const key = document.createElement('div'); key.className = 'key'; key.innerText = keyMap[k]; key.dataset.code = k; rowDiv.appendChild(key); });
                keyboardDiv.appendChild(rowDiv);
            });
            const spaceRow = document.createElement('div'); spaceRow.className = 'row'; spaceRow.innerHTML = '<div class="key space" data-code="Space">SPACE</div>'; keyboardDiv.appendChild(spaceRow);
        }
        createKeyboard();

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type, freq, vol, dur) { if (audioCtx.state === 'suspended') audioCtx.resume(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime); gain.gain.setValueAtTime(vol, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + dur); }
        function spawnParticles() { const rect = document.getElementById('input-field').getBoundingClientRect(); for (let i = 0; i < 25; i++) { const p = document.createElement('div'); p.className = 'particle'; p.style.color = ['#00f3ff', '#ff0055', '#0aff60', '#ffd700'][Math.floor(Math.random() * 4)]; p.style.left = (rect.left + rect.width / 2) + 'px'; p.style.top = (rect.top + rect.height / 2) + 'px'; const angle = Math.random() * Math.PI * 2; const v = Math.random() * 250 + 100; p.style.setProperty('--mx', Math.cos(angle) * v + 'px'); p.style.setProperty('--my', Math.sin(angle) * v + 'px'); document.body.appendChild(p); setTimeout(() => p.remove(), 800); } }

        const wordDisplay = document.getElementById('word-display');
        const inputField = document.getElementById('input-field');
        const remainingEl = document.getElementById('remaining');
        const accuracyEl = document.getElementById('accuracy');
        const comboEl = document.getElementById('combo-box');
        const progressFill = document.getElementById('progress-fill');
        const modeBtns = document.querySelectorAll('.mode-btn');

        let currentMode = 'word'; let targetList = []; let idx = 0; let correct = 0, attempts = 0, combo = 0; let score = 0, level = 1, mission = 'word'; let isPlaying = false;

        // --- Random Background Music Logic ---
        const songList = [
            "(Official) Evade OST - Countdown Before Mayhem.mp3",
            "(Official) Evade OST - FestiveZest Lobby Theme.mp3",
            "(Official) Evade OST - Last Holiday Lobby Theme.mp3",
            "(Official) Evade OST - Post Reference Lobby Theme.mp3",
            "BEANBASED.mp3",
            "C418 - Cat (Caution & Crisis Remix).mp3",
            "C418 - Sweden (Caution & Crisis Remix).mp3",
            "CARA_M4TH.mp3",
            "CRASH CAPITAL.mp3",
            "Friday Theme.mp3",
            "Gameplay I.mp3",
            "Gameplay II.mp3",
            "Imagine Dragons - Believer (Romy Wave Cover) [Not So Good Remix].mp3",
            "Lena Raine - otherside (Synthwave).mp3",
            "Photocathode - Unturned Arid Official Soundtrack.mp3",
            "Running From The Internet OST - Gameplay III.mp3",
            "Sunday Theme.mp3"
        ];

        const bgMusic = document.getElementById('bg-music');

        function playRandomMusic() {
            const randomSong = songList[Math.floor(Math.random() * songList.length)];
            bgMusic.src = "노래/" + randomSong;
            bgMusic.play().catch(e => console.log("Audio play failed (user interaction needed):", e));
        }

        if (bgMusic) {
            bgMusic.addEventListener('ended', playRandomMusic);
        }

        window.setMission = function (type) {
            mission = type;
            document.querySelector('.mission-select').style.display = 'none';
            if (type === 'pvp') {
                startPVP();
            } else {
                document.querySelector('.mode-select').style.display = 'flex';
                if (type === 'custom') { setMode('word'); } else { setMode(type); }
            }
        }

        window.setMode = function (m) { currentMode = m; modeBtns.forEach(b => b.classList.remove('active')); document.querySelector(`.mode-btn.${m === 'word' ? 'active' : ''}`).classList.add('active'); initGame(); }

        function initGame() {
            if (!isPvp) { score = 0; level = 1; } // Reset score if not PVP (PVP keeps score)
            updateHUD();

            // For PVP, use 100 words to allow for mistakes
            if (isPvp) {
                targetList = [];
                for (let i = 0; i < 100; i++) targetList.push(wordList[Math.floor(Math.random() * wordList.length)]);
            } else {
                targetList = (currentMode === 'word' ? [...wordList] : [...sentenceList]).sort(() => Math.random() - 0.5);
                if (currentMode === 'word') targetList = targetList.slice(0, 30);
            }

            idx = 0; correct = 0; attempts = 0; combo = 0; isPlaying = true;
            inputField.value = ''; inputField.disabled = false; inputField.focus();
            updateScreen();

            // Play random music if not playing
            if (bgMusic && (bgMusic.paused || !bgMusic.src)) {
                playRandomMusic();
            }

            playSound('sine', 880, 0.2, 0.5);
        }

        function updateHUD() {
            document.getElementById('score').innerText = score;
            document.getElementById('level').innerText = level;
        }

        function updateScreen() {
            if (idx >= targetList.length) { endGame(true); return; }
            wordDisplay.innerText = targetList[idx];
            // In PVP, show remaining correct words needed (Goal: 30)
            remainingEl.innerText = isPvp ? (30 - correct) : (targetList.length - idx);
            progressFill.style.width = (idx / targetList.length * 100) + '%';
            comboEl.innerText = combo > 0 ? `콤보 x${combo}` : '';
            comboEl.classList.toggle('active', combo > 0);
            updateHUD();
        }

        function endGame(win) {
            isPlaying = false;
            wordDisplay.innerHTML = win ? '미션 성공!<br>시스템 대기 중' : '게임 오버';

            if (isPvp) {
                const btn = document.createElement('button');
                btn.innerText = "메인으로 돌아가기";
                btn.className = "mission-btn active";
                btn.style.marginTop = "20px";
                btn.onclick = () => location.reload();
                wordDisplay.appendChild(document.createElement('br'));
                wordDisplay.appendChild(btn);
            }

            inputField.value = 'F5를 눌러 재부팅'; inputField.disabled = true;
            progressFill.style.width = '100%';
            spawnParticles(); spawnParticles();
            playSound('square', 440, 0.3, 0.1);
            setTimeout(() => playSound('square', 880, 0.3, 0.4), 150);
            saveUserData(); // Save on end
        }

        document.addEventListener('keydown', e => {
            const keyEl = document.querySelector(`.key[data-code="${e.code}"]`);
            if (keyEl) keyEl.classList.add('pressed');
            playSound('triangle', 150 + Math.random() * 300, 0.15, 0.08);

            if (e.key === 'Enter') {
                if (!isPlaying) {
                    if (!isPvp) initGame();
                    return;
                }
                const val = inputField.value.trim(); const target = targetList[idx];
                if (!val) return;
                attempts++;
                if (val === target) {
                    correct++; combo++; score += 10;
                    if (score >= level * 100) { level++; playSound('triangle', 660, 0.3, 0.3); saveUserData(); }
                    playSound('sawtooth', 500 + (combo * 80), 0.25, 0.2);
                    spawnParticles();
                    document.body.classList.add('shake-screen');
                    setTimeout(() => document.body.classList.remove('shake-screen'), 200);
                    if (isPvp) updatePVPProgress();
                } else {
                    combo = 0;
                    playSound('sawtooth', 100, 0.4, 0.3);
                    inputField.classList.add('shake-input');
                    setTimeout(() => inputField.classList.remove('shake-input'), 300);
                }
                idx++; inputField.value = '';
                accuracyEl.innerText = Math.floor((correct / attempts) * 100) + '%';
                updateScreen();
            }
        });

        document.addEventListener('keyup', e => { const keyEl = document.querySelector(`.key[data-code="${e.code}"]`); if (keyEl) keyEl.classList.remove('pressed'); });

        wordDisplay.innerText = '미션을 선택하고 엔터를 누르세요'; remainingEl.innerText = '-'; accuracyEl.innerText = '-';
    </script>
</body>

</html>
