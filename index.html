<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>HJNF</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7436486053633664"
    crossorigin="anonymous"></script>
  <style>
    body {
      min-height: 100vh;
      background: #18191c;
      font-family: 'Noto Sans KR', 'Montserrat', Arial, sans-serif;
      margin: 0;
      }

    @keyframes fadeInBg {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .container {
      max-width: 900px;
      width: 100%;
      margin: 80px auto 0 auto;
      background: #232428;
      border-radius: 18px;
      box-shadow: 0 6px 32px 0 rgba(0,0,0,0.18);
      padding: 40px 48px 48px 260px;
      position: relative;
      border: none;
      z-index: 1;
      color: #e3e3e3;
      min-height: 700px;
      overflow: visible;
    }
    /* Roblox style top nav */
    .roblox-nav {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 56px;
      background: #d32c2c;
      color: #fff;
      display: flex;
      align-items: center;
      z-index: 100;
      box-shadow: 0 2px 8px #0005;
    }
    .roblox-logo {
      font-weight: 900;
      font-size: 2.1rem;
      letter-spacing: 2px;
      margin-left: 32px;
      margin-right: 32px;
      font-family: 'Montserrat', 'Noto Sans KR', Arial, sans-serif;
      color: #fff;
      text-shadow: 0 2px 8px #0008;
    }
    .roblox-nav-links {
      display: flex;
      gap: 32px;
      font-size: 1.1rem;
      font-weight: 700;
    }
    .roblox-nav-links a {
      color: #fff;
      text-decoration: none;
      padding: 8px 0;
      border-bottom: 2px solid transparent;
      transition: border 0.2s;
    }
    .roblox-nav-links a:hover {
      border-bottom: 2px solid #fff;
    }
    .roblox-nav-search {
      margin-left: auto;
      margin-right: 40px;
    }
    .roblox-nav-search input {
      background: #232428;
      border: none;
      border-radius: 8px;
      padding: 8px 18px;
      color: #fff;
      font-size: 1rem;
      outline: none;
      width: 260px;
    }
    /* Roblox style sidebar */
    .roblox-sidebar {
      position: fixed;
      top: 56px;
      left: 0;
      width: 220px;
      height: calc(100vh - 56px);
      background: #202124;
      color: #fff;
      padding: 32px 0 0 0;
      z-index: 99;
      box-shadow: 2px 0 8px #0003;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .roblox-sidebar .sidebar-profile {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 0 24px 18px 24px;
      border-bottom: 1px solid #333;
      margin-bottom: 18px;
    }
    .roblox-sidebar .sidebar-profile .profile-img {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #444;
      object-fit: cover;
    }
    .roblox-sidebar .sidebar-profile .profile-name {
      font-weight: 800;
      font-size: 1.1rem;
      color: #fff;
    }
    .roblox-sidebar .sidebar-link {
      padding: 10px 32px;
      color: #e3e3e3;
      font-size: 1.05rem;
      text-decoration: none;
      font-weight: 600;
      border-left: 4px solid transparent;
      transition: background 0.15s, border 0.15s;
      border-radius: 0 18px 18px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .roblox-sidebar .sidebar-link:hover, .roblox-sidebar .sidebar-link.active {
      background: #232428;
      border-left: 4px solid #d32c2c;
      color: #fff;
    }
    .container::before {
      display: none !important;
    }
    @keyframes fadeInCard {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    h2, h3 {
      color: #fff;
      margin-top: 0;
      font-family: 'Montserrat', 'Noto Sans KR', Arial, sans-serif;
      letter-spacing: 1.2px;
      font-weight: 800;
      font-size: 2.1rem;
      margin-bottom: 18px;
    }
    input, textarea {
      font-family: inherit;
      font-size: 15px;
      border-radius: 8px;
      border: 1.5px solid #232428;
      margin-bottom: 16px;
      padding: 13px;
      outline: none;
      box-sizing: border-box;
      transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
      background: #232428;
      color: #fff;
      box-shadow: 0 1px 4px #18191c;
    }
    input:focus, textarea:focus {
      border-color: #d32c2c;
      box-shadow: 0 0 0 2px #d32c2c55, 0 2px 8px #d32c2c33;
      background: #232428;
      color: #fff;
    }
    button {
      background: #d32c2c;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
      margin-right: 8px;
      font-weight: 700;
      box-shadow: 0 2px 8px #d32c2c55;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      letter-spacing: 0.5px;
      font-size: 17px;
      border-radius: 12px;
    }
    button:hover {
      background: #b71c1c;
      box-shadow: 0 4px 16px #d32c2c55;
      transform: translateY(-2px) scale(1.04);
    }
    #formContainer {
      margin-top: 28px;
      animation: fadeInForm 0.8s;
      position: relative;
      z-index: 1;
    }
    @keyframes fadeInForm {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    #result {
      margin-top: 14px;
      color: #d32c2c;
      font-weight: bold;
      text-align: center;
      font-size: 17px;
      letter-spacing: 0.5px;
      border-radius: 8px;
      background: #232428;
      padding: 6px 0;
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 16px;
      background: #232428;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px #18191c;
      font-size: 16px;
      color: #e3e3e3;
    }
    th, td {
      padding: 14px 12px;
      border-bottom: 1px solid #232428;
      text-align: left;
    }
    th {
      background: #202124;
      color: #fff;
      font-weight: 800;
      letter-spacing: 0.5px;
      font-size: 16px;
      border-top: 1.5px solid #232428;
    }
    tr:last-child td {
      border-bottom: none;
    }
    #showSignup, #showLogin, #logoutBtn, #showCommunity {
      margin: 10px 6px 0 0;
      padding: 13px 28px;
      font-size: 17px;
      border-radius: 10px;
      border: none;
      background: #2196f3;
      color: #fff;
      box-shadow: 0 2px 8px #90caf9;
      font-weight: 700;
      letter-spacing: 0.5px;
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    #showSignup:hover, #showLogin:hover, #logoutBtn:hover, #showCommunity:hover {
      background: #1769aa;
      box-shadow: 0 4px 16px #2196f355;
      transform: translateY(-2px) scale(1.04);
    }
    #backToServer {
      background: #2196f3;
      color: #fff;
      border: none;
      font-weight: 700;
      margin-bottom: 18px;
      padding: 13px 24px;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
      box-shadow: 0 2px 8px #90caf9;
      letter-spacing: 0.5px;
    }
    #backToServer:hover {
      background: #1769aa;
      box-shadow: 0 4px 16px #2196f355;
      transform: translateY(-2px) scale(1.04);
    }
    .post-nickname {
      color: #d32c2c;
      font-size: 15px;
      font-weight: 700;
      margin-left: 10px;
      letter-spacing: 0.3px;
    }
    .post-content {
      color: #e3e3e3;
      margin: 8px 0 10px 0;
      display: block;
      font-size: 16px;
      line-height: 1.7;
    }
    .post-date {
      font-size: 13px;
      color: #bdbdbd;
      margin-left: 2px;
    }
    
    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    #modalBg {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    #modalContent {
      background: #232428;
      padding: 30px;
      border-radius: 15px;
      max-width: 500px;
      width: 90%;
      color: #fff;
      position: relative;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    
    #closeModal {
      position: absolute;
      top: 10px;
      right: 15px;
      background: none;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #closeModal:hover {
      background: rgba(255,255,255,0.1);
    }
    
    /* ë¡œê·¸ì¸/íšŒì›ê°€ì… ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #loginButtons button, #userInfo button {
      margin: 5px;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    #loginButtons button {
      background: #2196f3;
      color: #fff;
    }
    
    #loginButtons button:hover {
      background: #1769aa;
      transform: translateY(-2px);
    }
    
    #userInfo button {
      background: #f44336;
      color: #fff;
    }
    
    #userInfo button:hover {
      background: #d32f2f;
      transform: translateY(-2px);
    }
    
    /* ì°¨ë‹¨/IPì°¨ë‹¨ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .blockBtn, .ipBlockBtn {
      padding: 6px 12px;
      margin: 2px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .blockBtn {
      background: #f44336;
      color: #fff;
    }
    
    .blockBtn:hover {
      background: #d32f2f;
      transform: translateY(-1px);
    }
    
    .ipBlockBtn {
      background: #ff9800;
      color: #fff;
    }
    
    .ipBlockBtn:hover {
      background: #f57c00;
      transform: translateY(-1px);
    }
    
    /* ì„œë²„ ê´€ë¦¬ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .approveServerBtn, .rejectServerBtn, .stopServerBtn, .pauseServerBtn, .deleteServerBtn {
      padding: 6px 12px;
      margin: 2px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .approveServerBtn {
      background: #4caf50;
      color: #fff;
    }
    
    .approveServerBtn:hover {
      background: #388e3c;
      transform: translateY(-1px);
    }
    
    .rejectServerBtn {
      background: #f44336;
      color: #fff;
    }
    
    .rejectServerBtn:hover {
      background: #d32f2f;
      transform: translateY(-1px);
    }
    
    .stopServerBtn {
      background: #ff5722;
      color: #fff;
    }
    
    .stopServerBtn:hover {
      background: #e64a19;
      transform: translateY(-1px);
    }
    
    .pauseServerBtn {
      background: #ff9800;
      color: #fff;
    }
    
    .pauseServerBtn:hover {
      background: #f57c00;
      transform: translateY(-1px);
    }
    
    .deleteServerBtn {
      background: #9c27b0;
      color: #fff;
    }
    
    .deleteServerBtn:hover {
      background: #7b1fa2;
      transform: translateY(-1px);
    }
  </style>
</head>
<body>
  <!-- Roblox style top navigation bar -->
  <nav class="roblox-nav">
    <span class="roblox-logo">HJNF</span>
    <div class="roblox-nav-links">
      <a href="#" id="navHomeBtn">í™ˆ</a>
      <a href="#" id="navServerChartBtn">ì„œë²„ ì°¨íŠ¸</a>
      <a href="#" id="navCreateBtn">ë§Œë“¤ê¸°</a>
      <a href="#" id="navCommunityBtn">ì»¤ë®¤ë‹ˆí‹°</a>
    </div>
    <div class="roblox-nav-search">
      <input type="text" placeholder="ê²€ìƒ‰..." />
    </div>
  </nav>

  <!-- Roblox style left sidebar -->
  <aside class="roblox-sidebar">
    <a href="#" class="sidebar-link" id="sidebarProfileLink">í”„ë¡œí•„</a>
    <a href="#" class="sidebar-link" id="sidebarMessageLink">ë©”ì‹œì§€</a>
    <a href="#" class="sidebar-link" id="sidebarFriendsLink">ì¹œêµ¬</a>
  <a href="#" class="sidebar-link">ì¸ë²¤í† ë¦¬</a>
  <a href="#" class="sidebar-link"><b>í”„ë¦¬ë¯¸ì—„</b></a>
    <a href="#" class="sidebar-link">ì´ë²¤íŠ¸</a>
    <a href="#" class="sidebar-link" id="sidebarMembersBtn" style="display:none">ë§´ë²„ ëª©ë¡</a>
  </aside>

  <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
  <div class="container">
    <div id="formContainer">
      <h2>HJNF ì„œë²„ ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>
      <p>ë¡œë¸”ë¡ìŠ¤ ì„œë²„ë¥¼ ê´€ë¦¬í•˜ê³  ì¹œêµ¬ë“¤ê³¼ ì†Œí†µí•˜ì„¸ìš”!</p>
      <div id="loginButtons" style="margin-top: 20px;">
        <button id="showLogin">ë¡œê·¸ì¸</button>
        <button id="showSignup">íšŒì›ê°€ì…</button>
      </div>
      <div id="userInfo" style="display: none; margin-top: 20px;">
        <p>í™˜ì˜í•©ë‹ˆë‹¤, <span id="userNickname"></span>ë‹˜!</p>
        <button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </div>

  <!-- ëª¨ë‹¬ ë°°ê²½ -->
  <div id="modalBg">
    <div id="modalContent">
      <button id="closeModal">&times;</button>
    </div>
  </div>

  <div class="ad-left">
    <!-- Google AdSense ê´‘ê³  ì˜ì—­ -->
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-7436486053633664"
         data-ad-slot="1234567890"
         data-ad-format="auto"></ins>
    <script>
    // í”„ë¦¬ë¯¸ì—„ ë“±ê¸‰ ê´€ë¦¬ íŒ¨ë„ (ê´€ë¦¬ìë§Œ)
    function showPremiumPanel() {
      if (!auth.currentUser) {
        document.getElementById('formContainer').innerHTML = '<div style="color:red">ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>';
        return;
      }
      db.ref('users').once('value').then(snap => {
        const users = snap.val() || {};
        const isAdmin = auth.currentUser.uid === ADMIN_UID;
        let html = '<h2>í”„ë¦¬ë¯¸ì—„ ë“±ê¸‰ í˜„í™©</h2>';
        html += '<input type="text" id="premiumMemberSearchInput" placeholder="ë‹‰ë„¤ì„ ê²€ìƒ‰..." style="width:60%;padding:8px 12px;margin-bottom:12px;border-radius:8px;border:1.5px solid #232428;background:#18191c;color:#fff;font-size:1rem;outline:none;">';
        html += '<table id="premiumMemberTable" style="width:100%;background:#232428;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px #18191c;font-size:16px;color:#e3e3e3;">';
        html += '<tr><th>ë‹‰ë„¤ì„</th><th>ë“±ê¸‰</th>' + (isAdmin ? '<th>ì„¤ì •</th>' : '') + '</tr>';
        for (const uid in users) {
          if (uid === ADMIN_UID) continue;
          const user = users[uid];
          const grade = user.premium || '';
          html += '<tr data-nick="' + (user.robloxNickname || '') + '" data-email="' + (user.email || '') + '">' +
            '<td>' + (user.robloxNickname || '-') + '</td>' +
            '<td id="premiumGrade-' + uid + '">' + (grade ? grade : '-') + '</td>';
          if (isAdmin) {
            html += '<td>' +
              '<select class="premiumSelect" data-uid="' + uid + '">' +
                '<option value="">ì—†ìŒ</option>' +
                '<option value="VIP">VIP</option>' +
                '<option value="VIP+">VIP+</option>' +
                '<option value="MVP">MVP</option>' +
                '<option value="MVP+">MVP+</option>' +
              '</select>' +
              '<button class="setPremiumBtn" data-uid="' + uid + '">ì„¤ì •</button>' +
            '</td>';
          }
          html += '</tr>';
        }
        html += '</table>';
        document.getElementById('formContainer').innerHTML = html;
        // ê²€ìƒ‰ í•„í„°
        document.getElementById('premiumMemberSearchInput').addEventListener('input', function() {
          const v = this.value.trim().toLowerCase();
          document.querySelectorAll('#premiumMemberTable tr[data-nick]').forEach(function(tr) {
            const nick = tr.getAttribute('data-nick').toLowerCase();
            tr.style.display = nick.includes(v) ? '' : 'none';
          });
        });
        if (isAdmin) {
          // ë“±ê¸‰ select ê°’ ì„¸íŒ…
          document.querySelectorAll('.premiumSelect').forEach(function(sel) {
            const uid = sel.getAttribute('data-uid');
            const user = users[uid];
            if (user && user.premium) sel.value = user.premium;
          });
          // ì„¤ì • ë²„íŠ¼ ì´ë²¤íŠ¸
          document.querySelectorAll('.setPremiumBtn').forEach(function(btn) {
            btn.onclick = function() {
              const uid = btn.getAttribute('data-uid');
              const sel = document.querySelector('.premiumSelect[data-uid="' + uid + '"]');
              const grade = sel.value;
              db.ref('users/' + uid + '/premium').set(grade || null);
              document.getElementById('premiumGrade-' + uid).innerText = grade || '-';
              btn.textContent = 'ì €ì¥ë¨';
              setTimeout(() => { btn.textContent = 'ì„¤ì •'; }, 1000);
            };
          });
        }
      });
    }
// ë©”ì‹œì§€(ì¹œêµ¬ DM) íŒ¨ë„
function showMessagePanel() {
  if (!auth.currentUser) {
    document.getElementById('formContainer').innerHTML = '<div style="color:red">ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>';
    return;
  }
  
  db.ref('users/' + auth.currentUser.uid + '/friends').once('value').then(friendSnap => {
    const myFriends = friendSnap.val() || {};
    db.ref('users').once('value').then(snap => {
      const users = snap.val() || {};
      let html = '<h2>ë©”ì‹œì§€ (ì¹œêµ¬ ëª©ë¡)</h2>';
      
      // ì¹œêµ¬ê°€ ìˆëŠ”ì§€ í™•ì¸
      const friendUids = Object.keys(myFriends);
      if (friendUids.length === 0) {
        html += '<div style="background:#232428;padding:20px;border-radius:10px;text-align:center;color:#888;">';
        html += '<p>ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        html += '<p>ì¹œêµ¬ë¥¼ ì¶”ê°€í•œ í›„ ë©”ì‹œì§€ë¥¼ ì£¼ê³ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>';
        html += '<button onclick="showFriendsPanel()" style="margin-top:10px;padding:10px 20px;background:#2196f3;color:#fff;border:none;border-radius:8px;cursor:pointer;">ì¹œêµ¬ ì¶”ê°€í•˜ê¸°</button>';
        html += '</div>';
      } else {
        html += '<div style="background:#232428;padding:12px 18px;border-radius:10px;box-shadow:0 2px 8px #18191c;margin-bottom:18px;">';
        html += '<h3 style="color:#fff;margin:0 0 12px 0;">ğŸ’¬ ì¹œêµ¬ ëª©ë¡</h3>';
        html += '<ul id="dmFriendsList" style="list-style:none;margin:0;padding:0;">';
        
        friendUids.forEach(fuid => {
          if (users[fuid]) {
            html += '<li style="margin:8px 0;padding:12px;background:#333;border-radius:8px;cursor:pointer;transition:background 0.2s;" class="dmFriendItem" data-fuid="' + fuid + '" onmouseover="this.style.background=\'#444\'" onmouseout="this.style.background=\'#333\'">';
            html += '<div style="display:flex;align-items:center;gap:10px;">';
            html += '<div style="width:40px;height:40px;background:#555;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold;">' + (users[fuid].robloxNickname || 'U').charAt(0).toUpperCase() + '</div>';
            html += '<div>';
            html += '<div style="font-weight:600;color:#fff;">' + (users[fuid].robloxNickname || 'ìµëª…') + '</div>';
            html += '<div style="font-size:12px;color:#aaa;">ë©”ì‹œì§€ ë³´ë‚´ê¸°</div>';
            html += '</div>';
            html += '</div>';
            html += '</li>';
          }
        });
        
        html += '</ul>';
        html += '</div>';
      }
      
      html += '<div id="dmChatPanel"></div>';
      document.getElementById('formContainer').innerHTML = html;
      
      // ì¹œêµ¬ í´ë¦­ ì‹œ ì±„íŒ…ì°½ ì—´ê¸°
      document.querySelectorAll('.dmFriendItem').forEach(function(li) {
        li.onclick = function() {
          const fuid = li.getAttribute('data-fuid');
          showDmChatPanel(fuid, users[fuid].robloxNickname || fuid);
        };
      });
    });
  });
}

    // DM ì±„íŒ… íŒ¨ë„ (êµ¬í˜„ ì˜ˆì •)
// DM ì±„íŒ… íŒ¨ë„ (êµ¬í˜„ ì˜ˆì •)
function showDmChatPanel(friendUid, friendNick) {
  if (!auth.currentUser) return;
  const myUid = auth.currentUser.uid;
  // uid1_uid2 (ì •ë ¬)
  const chatKey = myUid < friendUid ? (myUid + '_' + friendUid) : (friendUid + '_' + myUid);
  let html = '<div style="font-weight:700;font-size:1.2rem;margin-bottom:10px">[' + friendNick + ']ë‹˜ê³¼ì˜ ì±„íŒ…</div>';
  html += '<div id="dmChatHistory" style="height:260px;overflow-y:auto;background:#232428;padding:12px 10px 12px 10px;border-radius:10px;margin-bottom:12px;border:1.5px solid #232428;"></div>';
  html += '<form id="dmChatForm" style="display:flex;gap:8px;"><input id="dmChatInput" type="text" placeholder="ë©”ì‹œì§€ ì…ë ¥..." style="flex:1;padding:10px 14px;border-radius:8px;border:1.5px solid #232428;background:#18191c;color:#fff;font-size:1rem;outline:none;"><button type="submit" style="background:#2196f3;color:#fff;font-weight:700;border:none;border-radius:8px;padding:10px 22px;">ì „ì†¡</button></form>';
  document.getElementById('dmChatPanel').innerHTML = html;

  // ë©”ì‹œì§€ ì‹¤ì‹œê°„ í‘œì‹œ
  const chatRef = db.ref('dmMessages/' + chatKey);
  chatRef.off();
  chatRef.on('value', function(snap) {
    const messages = snap.val() || {};
    let msgHtml = '';
    const msgArr = Object.entries(messages).sort((a, b) => a[1].timestamp - b[1].timestamp);
    msgArr.forEach(([key, msg]) => {
      const isMe = msg.from === myUid;
      msgHtml += '<div style="margin-bottom:8px;text-align:' + (isMe ? 'right' : 'left') + '">' +
        '<span style="display:inline-block;max-width:70%;padding:8px 14px;border-radius:12px;font-size:1rem;' +
        (isMe ? 'background:#2196f3;color:#fff;' : 'background:#333;color:#fff;') + '">' +
        (msg.text ? msg.text.replace(/</g,'&lt;').replace(/>/g,'&gt;') : '') +
        '</span><br>' +
        '<span style="font-size:11px;color:#aaa;margin-top:2px;">' +
        (msg.timeStr || '') + '</span>' +
        '</div>';
    });
    document.getElementById('dmChatHistory').innerHTML = msgHtml;
    // ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
    document.getElementById('dmChatHistory').scrollTop = 99999;
  });

  // ë©”ì‹œì§€ ì „ì†¡
  document.getElementById('dmChatForm').onsubmit = function(e) {
    e.preventDefault();
    const input = document.getElementById('dmChatInput');
    const text = input.value.trim();
    if (!text) return;
    const now = Date.now();
    const timeStr = new Date(now).toLocaleString();
    chatRef.push({
      from: myUid,
      to: friendUid,
      text,
      timestamp: now,
      timeStr
    });
    input.value = '';
  };
}

// ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° í•¨ìˆ˜ëŠ” í•­ìƒ ìµœìƒë‹¨ì— ìœ„ì¹˜ (ì „ì—­ì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
function openModal(contentHtml) {
  document.getElementById('modalContent').innerHTML = contentHtml;
  document.getElementById('modalBg').style.display = 'flex';
}
function closeModal() {
  document.getElementById('modalBg').style.display = 'none';
  document.getElementById('modalContent').innerHTML = '';
}

// ì°¨ë‹¨ëœ ìœ ì € ì°¨ë‹¨ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
function showBlockedMessage(nick) {
  document.body.style.background = '#fff';
  document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;width:100vw;"><div style="font-size:1.2rem;font-weight:700;color:#222;text-align:center;">' + (nick ? (nick + 'ë‹˜ì€ ì˜êµ¬ ì°¨ë‹¨ ë˜ì—ˆìŒë‹ˆë‹¤.') : 'ì˜êµ¬ ì°¨ë‹¨ëœ ê³„ì •ì…ë‹ˆë‹¤.') + '</div></div>';
}

// ì¹œêµ¬ íŒ¨ë„ í•¨ìˆ˜
function showFriendsPanel() {
  if (!auth.currentUser) {
    document.getElementById('formContainer').innerHTML = '<div style="color:red">ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>';
    return;
  }
  
  // ì¹œêµ¬ ìš”ì²­ì„ ê°€ì ¸ì˜¤ê¸°
  const loadFriendRequests = async () => {
    try {
      const requestSnap = await db.ref('friendRequests/' + auth.currentUser.uid).once('value');
      const requests = requestSnap.val() || {};
      const requestUids = Object.keys(requests).filter(uid => requests[uid].status === 'pending');
      
      let notifHtml = '';
      if (requestUids.length > 0) {
        notifHtml += '<div style="background:#ff9800;padding:16px 18px;border-radius:10px;margin-bottom:18px;box-shadow:0 2px 8px #18191c;">';
        notifHtml += '<h3 style="color:#fff;margin:0 0 12px 0;">ğŸ“¨ ë°›ì€ ì¹œêµ¬ ìš”ì²­ (' + requestUids.length + 'ê°œ)</h3>';
        notifHtml += '<ul style="margin:8px 0 0 0;padding:0;list-style:none;" id="friendRequestList">';
        
        // ê° ìš”ì²­ì— ëŒ€í•´ ë‹‰ë„¤ì„ì„ ê°€ì ¸ì™€ì„œ í‘œì‹œ
        for (const fromUid of requestUids) {
          const nickSnap = await db.ref('users/' + fromUid + '/robloxNickname').once('value');
          const nickname = nickSnap.val() || 'ìµëª…';
          const requestHtml = '<li style="margin:8px 0;padding:12px;background:#333;border-radius:8px;display:flex;justify-content:space-between;align-items:center;" data-fromuid="' + fromUid + '">' +
            '<div><strong>' + nickname + '</strong>ë‹˜ì´ ì¹œêµ¬ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.</div>' +
            '<div>' +
            '<button class="acceptFriendBtn" data-fromuid="' + fromUid + '" style="padding:6px 12px;background:#4caf50;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-right:5px;">ìˆ˜ë½</button>' +
            '<button class="rejectFriendBtn" data-fromuid="' + fromUid + '" style="padding:6px 12px;background:#f44336;color:#fff;border:none;border-radius:4px;cursor:pointer;">ê±°ì ˆ</button>' +
            '</div>' +
            '</li>';
          
          notifHtml += requestHtml;
        }
        
        notifHtml += '</ul></div>';
      }
      
      return notifHtml;
    } catch (error) {
      console.error('ì¹œêµ¬ ìš”ì²­ ë¡œë“œ ì˜¤ë¥˜:', error);
      return '';
    }
  };
  
  // ì¹œêµ¬ ëª©ë¡ì„ ê°€ì ¸ì˜¤ê¸°
  const loadFriendsList = async () => {
    try {
      const friendSnap = await db.ref('users/' + auth.currentUser.uid + '/friends').once('value');
      const myFriends = friendSnap.val() || {};
      const userSnap = await db.ref('users').once('value');
      const users = userSnap.val();
      
      const notifHtml = await loadFriendRequests();
      let html = notifHtml;
      html += '<h2>ë‚´ ì¹œêµ¬ ëª©ë¡</h2>';
      html += '<input type="text" id="friendSearchInput" placeholder="ë‹‰ë„¤ì„ ê²€ìƒ‰..." style="width:60%;padding:8px 12px;margin-bottom:12px;border-radius:8px;border:1.5px solid #232428;background:#18191c;color:#fff;font-size:1rem;outline:none;">';
      html += '<ul id="myFriendsList" style="background:#232428;padding:12px 18px;border-radius:10px;box-shadow:0 2px 8px #18191c;list-style:none;margin-bottom:18px;">';
      let hasFriend = false;
      for (const fuid in myFriends) {
        if (users[fuid]) {
          hasFriend = true;
          html += '<li style="margin:6px 0;" data-nick="' + (users[fuid].robloxNickname || '') + '">' +
            (users[fuid].robloxNickname || fuid) +
            ' <button class="deleteFriendBtn" data-fuid="' + fuid + '">ì¹œêµ¬ ì‚­ì œ</button></li>';
        }
      }
      if (!hasFriend) html += '<li>ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
      html += '</ul>';
      html += '<h2>ëª¨ë“  ë©¤ë²„ ëª©ë¡</h2>';
      html += '<input type="text" id="allMemberSearchInput" placeholder="ë‹‰ë„¤ì„ ê²€ìƒ‰..." style="width:60%;padding:8px 12px;margin-bottom:12px;border-radius:8px;border:1.5px solid #232428;background:#18191c;color:#fff;font-size:1rem;outline:none;">';
      html += '<table id="allMembersTable" style="width:100%;background:#232428;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px #18191c;font-size:16px;color:#e3e3e3;">';
      html += '<tr><th>ë‹‰ë„¤ì„</th><th>ì¹œêµ¬ ì¶”ê°€</th></tr>';
      for (const uid in users) {
        if (uid === auth.currentUser.uid) continue;
        const user = users[uid];
        const isFriend = myFriends[uid];
        html += '<tr data-nick="' + (user.robloxNickname || '') + '">' +
          '<td>' + (user.robloxNickname || '-') + '</td>' +
          '<td>' + (isFriend ? '<span style="color:#aaa">ì´ë¯¸ ì¹œêµ¬</span>' : '<button class="addFriendBtn" data-uid="' + uid + '">ì¹œêµ¬ ì¶”ê°€</button>') + '</td>' +
          '</tr>';
      }
      html += '</table>';
      setTimeout(function() {
        var input = document.getElementById('allMemberSearchInput');
        if (input) {
          input.addEventListener('input', function() {
            const v = this.value.trim().toLowerCase();
            document.querySelectorAll('#allMembersTable tr[data-nick]').forEach(function(tr) {
              if (!v) {
                tr.style.display = '';
              } else {
                const nick = tr.getAttribute('data-nick').toLowerCase();
                tr.style.display = (nick.includes(v)) ? '' : 'none';
              }
            });
          });
          document.querySelectorAll('#allMembersTable tr[data-nick]').forEach(function(tr) {
            tr.style.display = '';
          });
        }
      }, 100);
      setTimeout(function() {
        var input = document.getElementById('friendSearchInput');
        if (input) {
            input.addEventListener('input', function() {
              const v = this.value.trim().toLowerCase();
              document.querySelectorAll('#myFriendsList li[data-nick]').forEach(function(li) {
                if (!v) {
                  li.style.display = '';
                } else {
                  const nick = li.getAttribute('data-nick').toLowerCase();
                  li.style.display = nick.includes(v) ? '' : 'none';
                }
              });
            });
          document.querySelectorAll('#myFriendsList li[data-nick]').forEach(function(li) {
            li.style.display = '';
          });
        }
      }, 100);
      document.querySelectorAll('.addFriendBtn').forEach(function(btn) {
        btn.onclick = function() {
          const targetUid = btn.getAttribute('data-uid');
          
          // ì´ë¯¸ ì¹œêµ¬ì¸ì§€ í™•ì¸
          if (myFriends[targetUid]) {
            alert('ì´ë¯¸ ì¹œêµ¬ì…ë‹ˆë‹¤.');
            return;
          }
          
          // ì´ë¯¸ ìš”ì²­ì„ ë³´ëƒˆëŠ”ì§€ í™•ì¸
          db.ref('friendRequests/' + targetUid + '/' + auth.currentUser.uid).once('value').then(function(snap) {
            if (snap.exists()) {
              alert('ì´ë¯¸ ì¹œêµ¬ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.');
              return;
            }
            
            // ì¹œêµ¬ ìš”ì²­ ì „ì†¡
            db.ref('friendRequests/' + targetUid + '/' + auth.currentUser.uid).set({
              status: 'pending',
              requestedAt: Date.now(),
              requesterUid: auth.currentUser.uid
            }).then(() => {
              btn.disabled = true;
              btn.textContent = 'ìš”ì²­ë¨';
              btn.style.background = '#666';
              alert('ì¹œêµ¬ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤!');
            }).catch(error => {
              alert('ì¹œêµ¬ ìš”ì²­ ì „ì†¡ ì‹¤íŒ¨: ' + error.message);
            });
          });
        };
      });
      document.querySelectorAll('.deleteFriendBtn').forEach(function(btn) {
        btn.onclick = function() {
          const fuid = btn.getAttribute('data-fuid');
          db.ref('users/' + auth.currentUser.uid + '/friends/' + fuid).remove();
          db.ref('users/' + fuid + '/friends/' + auth.currentUser.uid).remove();
          showFriendsPanel();
        };
      });
      if (typeof requestUids !== 'undefined' && requestUids.length > 0) {
        requestUids.forEach(function(fromUid) {
          const req = requests[fromUid];
          if (req.status === 'pending') {
            db.ref('users/' + fromUid + '/robloxNickname').once('value').then(function(nickSnap) {
              const nick = nickSnap.val() || fromUid;
              const li = document.querySelector('li[data-fromuid="' + fromUid + '"]');
              if (li) {
                const acceptBtn = li.querySelector('.acceptFriendBtn');
                const rejectBtn = li.querySelector('.rejectFriendBtn');
                li.innerHTML = nick + 'ë‹˜ì—ê²Œ ì¹œêµ¬ ìš”ì²­ì´ ì™”ìŠµë‹ˆë‹¤ ';
                li.appendChild(acceptBtn);
                li.appendChild(rejectBtn);
              }
            });
          }
        });
        // ì¹œêµ¬ ìš”ì²­ ìˆ˜ë½/ê±°ì ˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        setTimeout(function() {
          document.querySelectorAll('.acceptFriendBtn').forEach(function(btn) {
            btn.onclick = function() {
              const fromUid = btn.getAttribute('data-fromuid');
              if (confirm('ì¹œêµ¬ ìš”ì²­ì„ ìˆ˜ë½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // ì–‘ë°©í–¥ ì¹œêµ¬ ê´€ê³„ ì„¤ì •
                db.ref('users/' + auth.currentUser.uid + '/friends/' + fromUid).set(true);
                db.ref('users/' + fromUid + '/friends/' + auth.currentUser.uid).set(true);
                // ì¹œêµ¬ ìš”ì²­ ì‚­ì œ
                db.ref('friendRequests/' + auth.currentUser.uid + '/' + fromUid).remove();
                alert('ì¹œêµ¬ ìš”ì²­ì„ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤!');
                showFriendsPanel(); // ì¹œêµ¬ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
              }
            };
          });
          
          document.querySelectorAll('.rejectFriendBtn').forEach(function(btn) {
            btn.onclick = function() {
              const fromUid = btn.getAttribute('data-fromuid');
              if (confirm('ì¹œêµ¬ ìš”ì²­ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // ì¹œêµ¬ ìš”ì²­ë§Œ ì‚­ì œ
                db.ref('friendRequests/' + auth.currentUser.uid + '/' + fromUid).remove();
                alert('ì¹œêµ¬ ìš”ì²­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.');
                showFriendsPanel(); // ì¹œêµ¬ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
              }
            };
          });
        }, 100);
      }
      
      document.getElementById('formContainer').innerHTML = html;
      
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
      setTimeout(() => {
        // ê²€ìƒ‰ ê¸°ëŠ¥
        const friendSearchInput = document.getElementById('friendSearchInput');
        if (friendSearchInput) {
          friendSearchInput.addEventListener('input', function() {
            const v = this.value.trim().toLowerCase();
            document.querySelectorAll('#myFriendsList li[data-nick]').forEach(function(li) {
              if (!v) {
                li.style.display = '';
              } else {
                const nick = li.getAttribute('data-nick').toLowerCase();
                li.style.display = nick.includes(v) ? '' : 'none';
              }
            });
          });
        }
        
        // ì¹œêµ¬ ì¶”ê°€ ë²„íŠ¼
        document.querySelectorAll('.addFriendBtn').forEach(function(btn) {
          btn.onclick = function() {
            const targetUid = btn.getAttribute('data-uid');
            
            if (myFriends[targetUid]) {
              alert('ì´ë¯¸ ì¹œêµ¬ì…ë‹ˆë‹¤.');
              return;
            }
            
            db.ref('friendRequests/' + targetUid + '/' + auth.currentUser.uid).once('value').then(function(snap) {
              if (snap.exists()) {
                alert('ì´ë¯¸ ì¹œêµ¬ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.');
                return;
              }
              
              db.ref('friendRequests/' + targetUid + '/' + auth.currentUser.uid).set({
                status: 'pending',
                requestedAt: Date.now(),
                requesterUid: auth.currentUser.uid
              }).then(() => {
                btn.disabled = true;
                btn.textContent = 'ìš”ì²­ë¨';
                btn.style.background = '#666';
                alert('ì¹œêµ¬ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤!');
              }).catch(error => {
                alert('ì¹œêµ¬ ìš”ì²­ ì „ì†¡ ì‹¤íŒ¨: ' + error.message);
              });
            });
          };
        });
        
        // ì¹œêµ¬ ì‚­ì œ ë²„íŠ¼
        document.querySelectorAll('.deleteFriendBtn').forEach(function(btn) {
          btn.onclick = function() {
            const fuid = btn.getAttribute('data-fuid');
            db.ref('users/' + auth.currentUser.uid + '/friends/' + fuid).remove();
            db.ref('users/' + fuid + '/friends/' + auth.currentUser.uid).remove();
            showFriendsPanel();
          };
        });
        
        // ì¹œêµ¬ ìš”ì²­ ìˆ˜ë½/ê±°ì ˆ ë²„íŠ¼
        document.querySelectorAll('.acceptFriendBtn').forEach(function(btn) {
          btn.onclick = function() {
            const fromUid = btn.getAttribute('data-fromuid');
            if (confirm('ì¹œêµ¬ ìš”ì²­ì„ ìˆ˜ë½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
              db.ref('users/' + auth.currentUser.uid + '/friends/' + fromUid).set(true);
              db.ref('users/' + fromUid + '/friends/' + auth.currentUser.uid).set(true);
              db.ref('friendRequests/' + auth.currentUser.uid + '/' + fromUid).remove();
              alert('ì¹œêµ¬ ìš”ì²­ì„ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤!');
              showFriendsPanel();
            }
          };
        });
        
        document.querySelectorAll('.rejectFriendBtn').forEach(function(btn) {
          btn.onclick = function() {
            const fromUid = btn.getAttribute('data-fromuid');
            if (confirm('ì¹œêµ¬ ìš”ì²­ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
              db.ref('friendRequests/' + auth.currentUser.uid + '/' + fromUid).remove();
              alert('ì¹œêµ¬ ìš”ì²­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.');
              showFriendsPanel();
            }
          };
        });
      }, 100);
      
    } catch (error) {
      console.error('ì¹œêµ¬ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
      document.getElementById('formContainer').innerHTML = '<div style="color:red">ì¹œêµ¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
    }
  };
  
  // í•¨ìˆ˜ í˜¸ì¶œ
  loadFriendsList();
}

// í”„ë¡œí•„(ë‚´ ì •ë³´) íŒ¨ë„
function showProfilePanel() {
  if (!auth.currentUser) {
    document.getElementById('formContainer').innerHTML = '<div style="color:red">ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>';
    return;
  }
  const uid = auth.currentUser.uid;
  db.ref('users/' + uid).once('value').then(snap => {
    const user = snap.val() || {};
    let html = '<h2>ë‚´ í”„ë¡œí•„</h2>';
    html += '<div style="background:#232428;padding:18px 22px;border-radius:10px;box-shadow:0 2px 8px #18191c;">';
    html += '<b>ë¡œë¸”ë¡ìŠ¤ ë‹‰ë„¤ì„:</b> ' + (user.robloxNickname || '-') + '<br>';
    html += '<b>ê°€ì… ì‹œê¸°:</b> ' + (user.createdAt ? new Date(user.createdAt).toLocaleString() : '-') + '<br>';
    // ì¸ë²¤í† ë¦¬
    const inv = (user.inventory && Array.isArray(user.inventory)) ? user.inventory : [];
    html += '<b>ì¸ë²¤í† ë¦¬:</b> ' + (inv.length ? inv.join(', ') : '-') + '<br>';
    // í”„ë¦¬ë¯¸ì—„
    html += '<b>í”„ë¦¬ë¯¸ì—„:</b> ' + (user.premium || '-') + '<br>';
    // ì„œë²„ ì •ë³´
    if (user.server) {
      html += '<b>ì„œë²„ ìƒì„± ì—¬ë¶€:</b> O<br>';
      html += '<b>ì„œë²„ ìƒì„± ì‹œê¸°:</b> ' + (user.server.requestedAt ? new Date(user.server.requestedAt).toLocaleString() : '-') + '<br>';
    } else {
      html += '<b>ì„œë²„ ìƒì„± ì—¬ë¶€:</b> X<br>';
      html += '<b>ì„œë²„ ìƒì„± ì‹œê¸°:</b> -<br>';
    }
    html += '</div>';
    document.getElementById('formContainer').innerHTML = html;
  });
}

// ë¡œë¸”ë¡ìŠ¤ ë‹‰ë„¤ì„ì„ ì‚¬ì´ë“œë°”ì— í‘œì‹œ
function setSidebarNickname(nick) {
  var el = document.getElementById('sidebarNickname');
  if (el) {
    el.textContent = nick || 'ë‹‰ë„¤ì„';
  }
}

// Firebase ì„¤ì •
const firebaseConfig = {
  apiKey: "AIzaSyDKxcKXSmKF6LAEnFzF387ZN4wC8iRz8mg",
  authDomain: "rugged-night-396106.firebaseapp.com",
  databaseURL: "https://rugged-night-396106-default-rtdb.firebaseio.com",
  projectId: "rugged-night-396106",
  storageBucket: "rugged-night-396106.appspot.com",
  messagingSenderId: "388578786746",
  appId: "1:388578786746:web:c50051b71731c153f6b183",
  measurementId: "G-SRLCD2LZT8"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();
const ADMIN_UID = "VDDnepBDUtMqoVv4z2pxIAoolV93";

// í™ˆ íŒ¨ë„ í•¨ìˆ˜
function showHomePanel() {
  if (!auth.currentUser) {
    document.getElementById('formContainer').innerHTML = 
      '<h2>HJNF ì„œë²„ ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>' +
      '<p>ë¡œë¸”ë¡ìŠ¤ ì„œë²„ë¥¼ ê´€ë¦¬í•˜ê³  ì¹œêµ¬ë“¤ê³¼ ì†Œí†µí•˜ì„¸ìš”!</p>' +
      '<div id="loginButtons" style="margin-top: 20px;">' +
      '<button id="showLogin">ë¡œê·¸ì¸</button>' +
      '<button id="showSignup">íšŒì›ê°€ì…</button>' +
      '</div>';
    return;
  }
      
  db.ref('users/' + auth.currentUser.uid).once('value').then(snap => {
    const user = snap.val() || {};
    let html = '<h2>í™ˆ</h2>';
    html += '<div style="background:#232428;padding:20px;border-radius:10px;margin-bottom:20px;">';
    html += '<h3>í™˜ì˜í•©ë‹ˆë‹¤, ' + (user.robloxNickname || 'ì‚¬ìš©ì') + 'ë‹˜!</h3>';
    html += '<p>ì„œë²„ ê´€ë¦¬ì™€ ì¹œêµ¬ë“¤ê³¼ì˜ ì†Œí†µì„ ì‹œì‘í•´ë³´ì„¸ìš”.</p>';
    html += '</div>';
    
    // ì„œë²„ ìƒíƒœ í‘œì‹œ (ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ìš© ì»¨í…Œì´ë„ˆ)
    html += '<div id="serverStatusContainer" style="background:#232428;padding:20px;border-radius:10px;margin-bottom:20px;">';
    html += '<h3>ë‚´ ì„œë²„ ìƒíƒœ</h3>';
    html += '<div id="serverStatusContent">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
    html += '</div>';
    
    // í”„ë¦¬ë¯¸ì—„ ìƒíƒœ í‘œì‹œ
    html += '<div style="background:#232428;padding:20px;border-radius:10px;margin-bottom:20px;">';
    html += '<h3>í”„ë¦¬ë¯¸ì—„ ìƒíƒœ</h3>';
    html += '<p><strong>ë“±ê¸‰:</strong> ' + (user.premium || 'ì—†ìŒ') + '</p>';
    html += '</div>';
    
    // ì¹œêµ¬ ìš”ì²­ ì•Œë¦¼ í‘œì‹œ
    html += '<div id="friendRequestNotifications" style="background:#232428;padding:20px;border-radius:10px;margin-bottom:20px;">';
    html += '<h3>ì¹œêµ¬ ìš”ì²­ ì•Œë¦¼</h3>';
    html += '<div id="pendingFriendRequests">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
    html += '</div>';
    
    // ì„œë²„ ì†Œìœ ììš© ë©¤ë²„ ê´€ë¦¬ íŒ¨ë„
    if (user.server && user.server.status === 'approved') {
      html += '<div style="background:#232428;padding:20px;border-radius:10px;margin-top:20px;">';
      html += '<h3>ë‚´ ì„œë²„ ë©¤ë²„ ê´€ë¦¬</h3>';
      html += '<p>ì„œë²„ ì°¸ì—¬ ì‹ ì²­ ìŠ¹ì¸ ë° ë©¤ë²„ ê´€ë¦¬</p>';
      html += '<button onclick="showServerMemberManagement()" style="margin-top:10px;padding:10px 20px;background:#4caf50;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;">ë©¤ë²„ ê´€ë¦¬</button>';
      html += '</div>';
    }
    
    // ê´€ë¦¬ììš© ì„œë²„ ê´€ë¦¬ íŒ¨ë„
    if (auth.currentUser.uid === ADMIN_UID) {
      html += '<div style="background:#232428;padding:20px;border-radius:10px;margin-top:20px;">';
      html += '<h3>ê´€ë¦¬ì ì„œë²„ ê´€ë¦¬</h3>';
      html += '<p>ì„œë²„ ìŠ¹ì¸/ê±°ì ˆ ë° ê´€ë¦¬ ê¸°ëŠ¥</p>';
      html += '<button onclick="showAdminServerManagement()" style="margin-top:10px;padding:10px 20px;background:#ff9800;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;">ì„œë²„ ê´€ë¦¬</button>';
      html += '</div>';
      
      // ì‹¤ì‹œê°„ ì„œë²„ ìš”ì²­ ì•Œë¦¼ í‘œì‹œ
      html += '<div id="serverRequestNotifications" style="background:#232428;padding:20px;border-radius:10px;margin-top:20px;">';
      html += '<h3>ì„œë²„ ìš”ì²­ ì•Œë¦¼</h3>';
      html += '<div id="pendingRequestsList">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
      html += '</div>';
      
      // ì‚¬ì´íŠ¸ ê´€ë¦¬ììš© ì°¸ì—¬ ìŠ¹ì¸ ì•Œë¦¼
      html += '<div id="joinApprovalNotifications" style="background:#232428;padding:20px;border-radius:10px;margin-top:20px;">';
      html += '<h3>ì°¸ì—¬ ìŠ¹ì¸ ì•Œë¦¼</h3>';
      html += '<div id="pendingJoinApprovals">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
      html += '</div>';
      
      // ì‚¬ì´íŠ¸ ê´€ë¦¬ììš© ì¶”ë°© ìŠ¹ì¸ ì•Œë¦¼
      html += '<div id="kickApprovalNotifications" style="background:#232428;padding:20px;border-radius:10px;margin-top:20px;">';
      html += '<h3>ì¶”ë°© ìŠ¹ì¸ ì•Œë¦¼</h3>';
      html += '<div id="pendingKickApprovals">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
      html += '</div>';
    }
        
        document.getElementById('formContainer').innerHTML = html;
        
        // ê´€ë¦¬ìì¸ ê²½ìš° ì‹¤ì‹œê°„ ì„œë²„ ìš”ì²­ ì•Œë¦¼ í‘œì‹œ
        if (auth.currentUser.uid === ADMIN_UID) {
          showRealtimeServerRequests();
          showRealtimeJoinApprovals();
          showRealtimeKickApprovals();
        }
        
        // ì„œë²„ ì†Œìœ ìì¸ ê²½ìš° ë©¤ë²„ ê´€ë¦¬ ì•Œë¦¼ í‘œì‹œ
        if (user.server && user.server.status === 'approved') {
          showRealtimeJoinRequests();
        }
        
        // ì‹¤ì‹œê°„ ì„œë²„ ìƒíƒœ ì—…ë°ì´íŠ¸
        showRealtimeServerStatus();
        
        // ì‹¤ì‹œê°„ ì¹œêµ¬ ìš”ì²­ ì•Œë¦¼ í‘œì‹œ
        showRealtimeFriendRequests();
      });
    }

    // ì‹¤ì‹œê°„ ì¹œêµ¬ ìš”ì²­ ì•Œë¦¼ í‘œì‹œ
    function showRealtimeFriendRequests() {
      if (!auth.currentUser) return;
      
      db.ref('friendRequests/' + auth.currentUser.uid).on('value', function(snap) {
        const requests = snap.val() || {};
        const pendingRequests = Object.keys(requests).filter(uid => requests[uid].status === 'pending');
        const container = document.getElementById('pendingFriendRequests');
        
        if (!container) return;
        
        if (pendingRequests.length === 0) {
          container.innerHTML = '<p style="color:#888;">ëŒ€ê¸°ì¤‘ì¸ ì¹œêµ¬ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        } else {
          let html = '<div style="background:#ff9800;padding:15px;border-radius:8px;margin-bottom:10px;">';
          html += '<p><strong>' + pendingRequests.length + 'ê°œì˜ ì¹œêµ¬ ìš”ì²­ì´ ìˆìŠµë‹ˆë‹¤!</strong></p>';
          html += '<p style="font-size:14px;color:#fff;">ì¹œêµ¬ íŒ¨ë„ì—ì„œ í™•ì¸í•˜ê³  ìˆ˜ë½í•˜ì„¸ìš”.</p>';
          html += '<button onclick="showFriendsPanel()" style="margin-top:10px;padding:8px 16px;background:#fff;color:#ff9800;border:none;border-radius:4px;cursor:pointer;font-weight:600;">ì¹œêµ¬ ìš”ì²­ í™•ì¸</button>';
          html += '</div>';
          container.innerHTML = html;
        }
      });
    }

    // ì‹¤ì‹œê°„ ì„œë²„ ìƒíƒœ ì—…ë°ì´íŠ¸
    function showRealtimeServerStatus() {
      if (!auth.currentUser) return;
      
      db.ref('users/' + auth.currentUser.uid + '/server').on('value', function(snap) {
        const server = snap.val();
        const container = document.getElementById('serverStatusContent');
        if (!container) return;
        
        if (server) {
          let statusKor = '';
          switch (server.status) {
            case 'pending': statusKor = 'ëŒ€ê¸°ì¤‘'; break;
            case 'approved': statusKor = 'ìš´ì˜ì¤‘'; break;
            case 'stopped': statusKor = 'ì •ì§€ë¨'; break;
            case 'paused': statusKor = 'ì¼ì‹œì •ì§€'; break;
            default: statusKor = server.status;
          }
          
          let html = '<p><strong>ìƒíƒœ:</strong> ' + statusKor + '</p>';
          html += '<p><strong>ìƒì„±ì¼:</strong> ' + (server.requestedAt ? new Date(server.requestedAt).toLocaleString() : '-') + '</p>';
          if (server.url) {
            html += '<p><strong>ì„œë²„ ì£¼ì†Œ:</strong> <a href="' + server.url + '" target="_blank" style="color:#2196f3;">' + server.url + '</a></p>';
          }
          
          // ìƒíƒœë³„ ë©”ì‹œì§€
          if (server.status === 'pending') {
            html += '<div style="background:#ff9800;padding:15px;border-radius:10px;margin-top:15px;">';
            html += '<p><strong>ì„œë²„ ìƒì„± ìš”ì²­ì´ ëŒ€ê¸°ì¤‘ì…ë‹ˆë‹¤.</strong></p>';
            html += '<p>ê´€ë¦¬ì ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>';
            html += '</div>';
          } else if (server.status === 'approved') {
            html += '<div style="background:#4caf50;padding:15px;border-radius:10px;margin-top:15px;">';
            html += '<p><strong>ì„œë²„ê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!</strong></p>';
            html += '<p>ì„œë²„ë¥¼ ìš´ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>';
            html += '</div>';
          } else if (server.status === 'paused') {
            html += '<div style="background:#ff9800;padding:15px;border-radius:10px;margin-top:15px;">';
            html += '<p><strong>ì„œë²„ê°€ ì¼ì‹œì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.</strong></p>';
            html += '<p>ì„œë²„ë¥¼ ë‹¤ì‹œ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>';
            html += '<button onclick="resumeServer()" style="margin-top:10px;padding:10px 20px;background:#4caf50;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;">ì„œë²„ ì¬ê°œ</button>';
            html += '</div>';
          } else if (server.status === 'stopped') {
            html += '<div style="background:#f44336;padding:15px;border-radius:10px;margin-top:15px;">';
            html += '<p><strong>ì„œë²„ê°€ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.</strong></p>';
            html += '<p>ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.</p>';
            html += '</div>';
          }
          
          container.innerHTML = html;
        } else {
          container.innerHTML = '<p>ì•„ì§ ì„œë²„ê°€ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ë¥¼ ìƒì„±í•´ë³´ì„¸ìš”!</p>' +
            '<button onclick="showServerRequestForm()" style="margin-top:10px;padding:10px 20px;background:#d32c2c;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;">ì„œë²„ ìƒì„± ìš”ì²­</button>';
        }
      });
    }

    // ì‹¤ì‹œê°„ ì„œë²„ ìš”ì²­ ì•Œë¦¼ í‘œì‹œ
    function showRealtimeServerRequests() {
      db.ref('users').orderByChild('server/status').equalTo('pending').on('value', function(snap) {
        const users = snap.val() || {};
        let html = '';
        
        for (const uid in users) {
          const user = users[uid];
          if (user.server && user.server.status === 'pending') {
            html += '<div style="background:#ff9800;padding:15px;border-radius:8px;margin-bottom:10px;">';
            html += '<p><strong>' + (user.robloxNickname || 'ìµëª…') + 'ë‹˜</strong>ì´ ì„œë²„ ìƒì„±ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤.</p>';
            html += '<p style="font-size:12px;color:#ccc;">ìš”ì²­ ì‹œê°„: ' + (user.server.requestedAt ? new Date(user.server.requestedAt).toLocaleString() : '-') + '</p>';
            html += '<div style="margin-top:10px;">';
            html += '<input type="text" id="serverUrl-' + uid + '" placeholder="ì„œë²„ URL ì…ë ¥" style="width:200px;padding:5px;margin-right:10px;border-radius:4px;border:1px solid #333;background:#18191c;color:#fff;">';
            html += '<button onclick="approveServerRequest(\'' + uid + '\')" style="padding:5px 15px;background:#4caf50;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-right:5px;">ìŠ¹ì¸</button>';
            html += '<button onclick="rejectServerRequest(\'' + uid + '\')" style="padding:5px 15px;background:#f44336;color:#fff;border:none;border-radius:4px;cursor:pointer;">ê±°ì ˆ</button>';
            html += '</div>';
            html += '</div>';
          }
        }
        
        if (!html) {
          html = '<p style="color:#ccc;">ëŒ€ê¸°ì¤‘ì¸ ì„œë²„ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
        
        const container = document.getElementById('pendingRequestsList');
        if (container) {
          container.innerHTML = html;
        }
      });
    }

    // ì„œë²„ ìš”ì²­ ìŠ¹ì¸
    function approveServerRequest(uid) {
      const serverUrl = document.getElementById('serverUrl-' + uid).value.trim();
      if (!serverUrl) {
        alert('ì„œë²„ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (confirm('ì„œë²„ ìš”ì²­ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        db.ref('users/' + uid + '/server').update({
          status: 'approved',
          url: serverUrl,
          approvedAt: Date.now()
        }).then(() => {
          alert('ì„œë²„ ìš”ì²­ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
        });
      }
    }

    // ì„œë²„ ìš”ì²­ ê±°ì ˆ
    function rejectServerRequest(uid) {
      if (confirm('ì„œë²„ ìš”ì²­ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        db.ref('users/' + uid + '/server').remove().then(() => {
          alert('ì„œë²„ ìš”ì²­ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.');
        });
      }
    }

    // ì„œë²„ ì†Œìœ ììš© ë©¤ë²„ ê´€ë¦¬ íŒ¨ë„
    function showServerMemberManagement() {
      if (!auth.currentUser) {
        document.getElementById('formContainer').innerHTML = '<div style="color:red">ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>';
        return;
      }
      
      let html = '<h2>ì„œë²„ ë©¤ë²„ ê´€ë¦¬</h2>';
      html += '<div id="joinRequestsContainer" style="background:#232428;padding:20px;border-radius:10px;margin-bottom:20px;">';
      html += '<h3>ì°¸ì—¬ ì‹ ì²­ ëª©ë¡</h3>';
      html += '<div id="joinRequestsList">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
      html += '</div>';
      
      html += '<div id="serverMembersContainer" style="background:#232428;padding:20px;border-radius:10px;">';
      html += '<h3>ì„œë²„ ë©¤ë²„ ëª©ë¡</h3>';
      html += '<div id="serverMembersList">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
      html += '</div>';
      
      document.getElementById('formContainer').innerHTML = html;
      
      // ì‹¤ì‹œê°„ ì°¸ì—¬ ì‹ ì²­ ë° ë©¤ë²„ ëª©ë¡ í‘œì‹œ
      showRealtimeJoinRequests();
      showRealtimeServerMembers();
    }

    // ì‹¤ì‹œê°„ ì°¸ì—¬ ì‹ ì²­ í‘œì‹œ
    function showRealtimeJoinRequests() {
      if (!auth.currentUser) return;
      
      db.ref('serverJoinRequests/' + auth.currentUser.uid).on('value', function(snap) {
        const requests = snap.val() || {};
        let html = '';
        
        for (const requesterUid in requests) {
          const request = requests[requesterUid];
          if (request.status === 'pending') {
            db.ref('users/' + requesterUid + '/robloxNickname').once('value').then(nickSnap => {
              const nickname = nickSnap.val() || 'ìµëª…';
              html += '<div style="background:#ff9800;padding:15px;border-radius:8px;margin-bottom:10px;">';
              html += '<p><strong>' + nickname + 'ë‹˜</strong>ì´ ì„œë²„ ì°¸ì—¬ë¥¼ ì‹ ì²­í–ˆìŠµë‹ˆë‹¤.</p>';
              html += '<p style="font-size:12px;color:#ccc;">ì‹ ì²­ ì‹œê°„: ' + (request.requestedAt ? new Date(request.requestedAt).toLocaleString() : '-') + '</p>';
              html += '<div style="margin-top:10px;">';
              html += '<button onclick="approveJoinRequest(\'' + requesterUid + '\')" style="padding:5px 15px;background:#4caf50;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-right:5px;">ìŠ¹ì¸</button>';
              html += '<button onclick="rejectJoinRequest(\'' + requesterUid + '\')" style="padding:5px 15px;background:#f44336;color:#fff;border:none;border-radius:4px;cursor:pointer;">ê±°ì ˆ</button>';
              html += '</div>';
              html += '</div>';
              
              const container = document.getElementById('joinRequestsList');
              if (container) {
                container.innerHTML = html;
              }
            });
          }
        }
        
        if (!html) {
          html = '<p style="color:#ccc;">ëŒ€ê¸°ì¤‘ì¸ ì°¸ì—¬ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          const container = document.getElementById('joinRequestsList');
          if (container) {
            container.innerHTML = html;
          }
        }
      });
    }

    // ì°¸ì—¬ ì‹ ì²­ ìŠ¹ì¸
    function approveJoinRequest(requesterUid) {
      if (confirm('ì°¸ì—¬ ì‹ ì²­ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        // 1ë‹¨ê³„: ì„œë²„ ì†Œìœ ì ìŠ¹ì¸
        db.ref('serverJoinRequests/' + auth.currentUser.uid + '/' + requesterUid).update({
          status: 'approved',
          approvedAt: Date.now()
        }).then(() => {
          // 2ë‹¨ê³„: ì‚¬ì´íŠ¸ ê´€ë¦¬ì ìŠ¹ì¸ ìš”ì²­
          db.ref('serverJoinApprovals/' + auth.currentUser.uid + '/' + requesterUid).set({
            status: 'pending',
            requestedAt: Date.now(),
            serverOwnerUid: auth.currentUser.uid,
            requesterUid: requesterUid
          }).then(() => {
            alert('ì°¸ì—¬ ì‹ ì²­ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ì´íŠ¸ ê´€ë¦¬ì ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
          });
        });
      }
    }

    // ì°¸ì—¬ ì‹ ì²­ ê±°ì ˆ
    function rejectJoinRequest(requesterUid) {
      if (confirm('ì°¸ì—¬ ì‹ ì²­ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        db.ref('serverJoinRequests/' + auth.currentUser.uid + '/' + requesterUid).update({
          status: 'rejected',
          rejectedAt: Date.now()
        }).then(() => {
          alert('ì°¸ì—¬ ì‹ ì²­ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.');
        });
      }
    }

    // ì‹¤ì‹œê°„ ì„œë²„ ë©¤ë²„ ëª©ë¡ í‘œì‹œ
    function showRealtimeServerMembers() {
      if (!auth.currentUser) return;
      
      db.ref('serverMembers/' + auth.currentUser.uid).on('value', function(snap) {
        const members = snap.val() || {};
        let html = '';
        
        for (const memberUid in members) {
          const member = members[memberUid];
          if (member.status === 'approved') {
            db.ref('users/' + memberUid + '/robloxNickname').once('value').then(nickSnap => {
              const nickname = nickSnap.val() || 'ìµëª…';
              html += '<div style="background:#4caf50;padding:15px;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">';
              html += '<div>';
              html += '<p><strong>' + nickname + '</strong></p>';
              html += '<p style="font-size:12px;color:#ccc;">ê°€ì…ì¼: ' + (member.joinedAt ? new Date(member.joinedAt).toLocaleString() : '-') + '</p>';
              html += '</div>';
              html += '<button onclick="kickServerMember(\'' + memberUid + '\')" style="padding:5px 15px;background:#f44336;color:#fff;border:none;border-radius:4px;cursor:pointer;">ì¶”ë°©</button>';
              html += '</div>';
              
              const container = document.getElementById('serverMembersList');
              if (container) {
                container.innerHTML = html;
              }
            });
          }
        }
        
        if (!html) {
          html = '<p style="color:#ccc;">ì„œë²„ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          const container = document.getElementById('serverMembersList');
          if (container) {
            container.innerHTML = html;
          }
        }
      });
    }

    // ì„œë²„ ë©¤ë²„ ì¶”ë°©
    function kickServerMember(memberUid) {
      if (confirm('ì´ ë©¤ë²„ë¥¼ ì¶”ë°©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        // ì¶”ë°© ìš”ì²­ì„ ì‚¬ì´íŠ¸ ê´€ë¦¬ìì—ê²Œ ì „ì†¡
        db.ref('kickRequests/' + auth.currentUser.uid + '/' + memberUid).set({
          status: 'pending',
          requestedAt: Date.now(),
          serverOwnerUid: auth.currentUser.uid,
          memberUid: memberUid
        }).then(() => {
          alert('ì¶”ë°© ìš”ì²­ì´ ì‚¬ì´íŠ¸ ê´€ë¦¬ìì—ê²Œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        });
      }
    }

    // ì‚¬ì´íŠ¸ ê´€ë¦¬ììš© ì°¸ì—¬ ìŠ¹ì¸ ì•Œë¦¼ í‘œì‹œ
    function showRealtimeJoinApprovals() {
      if (!auth.currentUser || auth.currentUser.uid !== ADMIN_UID) return;
      
      db.ref('serverJoinApprovals').on('value', function(snap) {
        const approvals = snap.val() || {};
        let html = '';
        
        for (const serverOwnerUid in approvals) {
          const serverApprovals = approvals[serverOwnerUid];
          for (const requesterUid in serverApprovals) {
            const approval = serverApprovals[requesterUid];
            if (approval.status === 'pending') {
              // ì„œë²„ ì†Œìœ ìì™€ ì‹ ì²­ì ë‹‰ë„¤ì„ ê°€ì ¸ì˜¤ê¸°
              Promise.all([
                db.ref('users/' + serverOwnerUid + '/robloxNickname').once('value'),
                db.ref('users/' + requesterUid + '/robloxNickname').once('value')
              ]).then(([ownerSnap, requesterSnap]) => {
                const ownerNick = ownerSnap.val() || 'ìµëª…';
                const requesterNick = requesterSnap.val() || 'ìµëª…';
                
                html += '<div style="background:#2196f3;padding:15px;border-radius:8px;margin-bottom:10px;">';
                html += '<p><strong>' + requesterNick + 'ë‹˜</strong>ì´ <strong>' + ownerNick + 'ë‹˜</strong>ì˜ ì„œë²„ ì°¸ì—¬ë¥¼ ìš”ì²­í–ˆìŠµë‹ˆë‹¤.</p>';
                html += '<p style="font-size:12px;color:#ccc;">ìš”ì²­ ì‹œê°„: ' + (approval.requestedAt ? new Date(approval.requestedAt).toLocaleString() : '-') + '</p>';
                html += '<div style="margin-top:10px;">';
                html += '<button onclick="approveJoinApproval(\'' + serverOwnerUid + '\', \'' + requesterUid + '\')" style="padding:5px 15px;background:#4caf50;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-right:5px;">ìŠ¹ì¸</button>';
                html += '<button onclick="rejectJoinApproval(\'' + serverOwnerUid + '\', \'' + requesterUid + '\')" style="padding:5px 15px;background:#f44336;color:#fff;border:none;border-radius:4px;cursor:pointer;">ê±°ì ˆ</button>';
                html += '</div>';
                html += '</div>';
                
                const container = document.getElementById('pendingJoinApprovals');
                if (container) {
                  container.innerHTML = html;
                }
              });
            }
          }
        }
        
        if (!html) {
          html = '<p style="color:#ccc;">ëŒ€ê¸°ì¤‘ì¸ ì°¸ì—¬ ìŠ¹ì¸ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          const container = document.getElementById('pendingJoinApprovals');
          if (container) {
            container.innerHTML = html;
          }
        }
      });
    }

    // ì°¸ì—¬ ìŠ¹ì¸ ìŠ¹ì¸
    function approveJoinApproval(serverOwnerUid, requesterUid) {
      if (confirm('ì°¸ì—¬ ìŠ¹ì¸ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        // ì‚¬ì´íŠ¸ ê´€ë¦¬ì ìŠ¹ì¸
        db.ref('serverJoinApprovals/' + serverOwnerUid + '/' + requesterUid).update({
          status: 'approved',
          approvedAt: Date.now()
        }).then(() => {
          // ì„œë²„ ë©¤ë²„ë¡œ ì¶”ê°€
          db.ref('serverMembers/' + serverOwnerUid + '/' + requesterUid).set({
            status: 'approved',
            joinedAt: Date.now()
          }).then(() => {
            alert('ì°¸ì—¬ ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          });
        });
      }
    }

    // ì°¸ì—¬ ìŠ¹ì¸ ê±°ì ˆ
    function rejectJoinApproval(serverOwnerUid, requesterUid) {
      if (confirm('ì°¸ì—¬ ìŠ¹ì¸ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        db.ref('serverJoinApprovals/' + serverOwnerUid + '/' + requesterUid).update({
          status: 'rejected',
          rejectedAt: Date.now()
        }).then(() => {
          alert('ì°¸ì—¬ ìŠ¹ì¸ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.');
        });
      }
    }

    // ì‚¬ì´íŠ¸ ê´€ë¦¬ììš© ì¶”ë°© ìŠ¹ì¸ ì•Œë¦¼ í‘œì‹œ
    function showRealtimeKickApprovals() {
      if (!auth.currentUser || auth.currentUser.uid !== ADMIN_UID) return;
      
      db.ref('kickRequests').on('value', function(snap) {
        const kickRequests = snap.val() || {};
        let html = '';
        
        for (const serverOwnerUid in kickRequests) {
          const serverKicks = kickRequests[serverOwnerUid];
          for (const memberUid in serverKicks) {
            const kickRequest = serverKicks[memberUid];
            if (kickRequest.status === 'pending') {
              // ì„œë²„ ì†Œìœ ìì™€ ë©¤ë²„ ë‹‰ë„¤ì„ ê°€ì ¸ì˜¤ê¸°
              Promise.all([
                db.ref('users/' + serverOwnerUid + '/robloxNickname').once('value'),
                db.ref('users/' + memberUid + '/robloxNickname').once('value')
              ]).then(([ownerSnap, memberSnap]) => {
                const ownerNick = ownerSnap.val() || 'ìµëª…';
                const memberNick = memberSnap.val() || 'ìµëª…';
                
                html += '<div style="background:#f44336;padding:15px;border-radius:8px;margin-bottom:10px;">';
                html += '<p><strong>' + ownerNick + 'ë‹˜</strong>ì´ <strong>' + memberNick + 'ë‹˜</strong>ì˜ ì¶”ë°©ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤.</p>';
                html += '<p style="font-size:12px;color:#ccc;">ìš”ì²­ ì‹œê°„: ' + (kickRequest.requestedAt ? new Date(kickRequest.requestedAt).toLocaleString() : '-') + '</p>';
                html += '<div style="margin-top:10px;">';
                html += '<button onclick="approveKickRequest(\'' + serverOwnerUid + '\', \'' + memberUid + '\')" style="padding:5px 15px;background:#f44336;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-right:5px;">ì¶”ë°© ìŠ¹ì¸</button>';
                html += '<button onclick="rejectKickRequest(\'' + serverOwnerUid + '\', \'' + memberUid + '\')" style="padding:5px 15px;background:#666;color:#fff;border:none;border-radius:4px;cursor:pointer;">ê±°ì ˆ</button>';
                html += '</div>';
                html += '</div>';
                
                const container = document.getElementById('pendingKickApprovals');
                if (container) {
                  container.innerHTML = html;
                }
              });
            }
          }
        }
        
        if (!html) {
          html = '<p style="color:#ccc;">ëŒ€ê¸°ì¤‘ì¸ ì¶”ë°© ìŠ¹ì¸ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          const container = document.getElementById('pendingKickApprovals');
          if (container) {
            container.innerHTML = html;
          }
        }
      });
    }

    // ì¶”ë°© ìŠ¹ì¸
    function approveKickRequest(serverOwnerUid, memberUid) {
      if (confirm('ì¶”ë°©ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        // ì¶”ë°© ìŠ¹ì¸
        db.ref('kickRequests/' + serverOwnerUid + '/' + memberUid).update({
          status: 'approved',
          approvedAt: Date.now()
        }).then(() => {
          // ì„œë²„ ë©¤ë²„ì—ì„œ ì œê±°
          db.ref('serverMembers/' + serverOwnerUid + '/' + memberUid).remove().then(() => {
            alert('ì¶”ë°©ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          });
        });
      }
    }

    // ì¶”ë°© ê±°ì ˆ
    function rejectKickRequest(serverOwnerUid, memberUid) {
      if (confirm('ì¶”ë°©ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        db.ref('kickRequests/' + serverOwnerUid + '/' + memberUid).update({
          status: 'rejected',
          rejectedAt: Date.now()
        }).then(() => {
          alert('ì¶”ë°©ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.');
        });
      }
    }

    // ë¡œê·¸ì¸ í•¨ìˆ˜
    function showLoginForm() {
      const html = 
        '<h2>ë¡œê·¸ì¸</h2>' +
        '<form id="loginForm">' +
        '<input type="email" id="loginEmail" placeholder="ì´ë©”ì¼" required>' +
        '<input type="password" id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸" required>' +
        '<button type="submit">ë¡œê·¸ì¸</button>' +
        '</form>';
      openModal(html);
      
      document.getElementById('loginForm').onsubmit = function(e) {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        
        auth.signInWithEmailAndPassword(email, password)
          .then(() => {
            closeModal();
            // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ìë™ìœ¼ë¡œ í™ˆìœ¼ë¡œ ì´ë™
            setTimeout(() => {
              showHomePanel();
            }, 100);
          })
          .catch(error => {
            alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message);
          });
      };
    }

    // íšŒì›ê°€ì… í•¨ìˆ˜
    function showSignupForm() {
      const html = 
        '<h2>íšŒì›ê°€ì…</h2>' +
        '<form id="signupForm">' +
        '<input type="email" id="signupEmail" placeholder="ì´ë©”ì¼" required>' +
        '<input type="password" id="signupPassword" placeholder="ë¹„ë°€ë²ˆí˜¸" required>' +
        '<input type="text" id="robloxNickname" placeholder="ë¡œë¸”ë¡ìŠ¤ ë‹‰ë„¤ì„" required>' +
        '<button type="submit">íšŒì›ê°€ì…</button>' +
        '</form>';
      openModal(html);
      
      document.getElementById('signupForm').onsubmit = function(e) {
        e.preventDefault();
        const email = document.getElementById('signupEmail').value;
        const password = document.getElementById('signupPassword').value;
        const nickname = document.getElementById('robloxNickname').value;
        
        auth.createUserWithEmailAndPassword(email, password)
          .then(userCredential => {
            const user = userCredential.user;
            return db.ref('users/' + user.uid).set({
              email: email,
              robloxNickname: nickname,
              createdAt: Date.now()
            });
          })
          .then(() => {
            closeModal();
            // íšŒì›ê°€ì… ì„±ê³µ ì‹œ ìë™ìœ¼ë¡œ í™ˆìœ¼ë¡œ ì´ë™
            setTimeout(() => {
              showHomePanel();
            }, 100);
          })
          .catch(error => {
            alert('íšŒì›ê°€ì… ì‹¤íŒ¨: ' + error.message);
          });
      };
    }

    // ì„œë²„ ì¬ê°œ í•¨ìˆ˜
    function resumeServer() {
      if (!auth.currentUser) {
        alert('ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
      }
      
      if (confirm('ì„œë²„ë¥¼ ì¬ê°œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        db.ref('users/' + auth.currentUser.uid + '/server/status').set('approved').then(() => {
          alert('ì„œë²„ê°€ ì¬ê°œë˜ì—ˆìŠµë‹ˆë‹¤.');
          showHomePanel(); // í™ˆ íŒ¨ë„ ìƒˆë¡œê³ ì¹¨
        }).catch(error => {
          alert('ì„œë²„ ì¬ê°œ ì‹¤íŒ¨: ' + error.message);
        });
      }
    }

    // ì„œë²„ ìƒì„± ìš”ì²­ í¼ (ê°„ì†Œí™”)
    function showServerRequestForm() {
      if (!auth.currentUser) {
        alert('ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
      }
      
      if (confirm('ì„œë²„ ìƒì„± ìš”ì²­ì„ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        db.ref('users/' + auth.currentUser.uid + '/server').set({
          status: 'pending',
          requestedAt: Date.now(),
          requestedBy: auth.currentUser.uid
        })
        .then(() => {
          // ê´€ë¦¬ìì—ê²Œ ì‹¤ì‹œê°„ ì•Œë¦¼ ì „ì†¡
          db.ref('adminNotifications/serverRequests').push({
            userId: auth.currentUser.uid,
            userNickname: '', // ë‹‰ë„¤ì„ì€ ë³„ë„ë¡œ ê°€ì ¸ì˜¬ ì˜ˆì •
            timestamp: Date.now(),
            type: 'serverRequest'
          });
          
          showHomePanel();
          alert('ì„œë²„ ìƒì„± ìš”ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ì ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
        })
        .catch(error => {
          alert('ìš”ì²­ ì‹¤íŒ¨: ' + error.message);
        });
      }
    }

    // ì»¤ë®¤ë‹ˆí‹° íŒ¨ë„
    function showCommunity() {
      if (!auth.currentUser) {
        document.getElementById('formContainer').innerHTML = '<div style="color:red">ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>';
        return;
      }
      
      let html = '<h2>ì»¤ë®¤ë‹ˆí‹°</h2>';
      html += '<div style="margin-bottom: 20px;">';
      html += '<textarea id="postContent" placeholder="ê²Œì‹œê¸€ì„ ì‘ì„±í•˜ì„¸ìš”..." rows="4" style="width: 100%; margin-bottom: 10px;"></textarea>';
      html += '<button onclick="submitPost()">ê²Œì‹œí•˜ê¸°</button>';
      html += '</div>';
      html += '<div id="postsList">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
      
      document.getElementById('formContainer').innerHTML = html;
      
      // ê²Œì‹œê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
      db.ref('posts').orderByChild('timestamp').limitToLast(20).on('value', function(snap) {
        const posts = snap.val() || {};
        let postsHtml = '';
        const postsArray = Object.entries(posts).reverse();
        
        postsArray.forEach(([key, post]) => {
          postsHtml += '<div style="background:#232428;padding:15px;border-radius:10px;margin-bottom:15px;">';
          postsHtml += '<div class="post-nickname">' + (post.nickname || 'ìµëª…') + '</div>';
          postsHtml += '<div class="post-content">' + post.content + '</div>';
          postsHtml += '<div class="post-date">' + (post.timeStr || '') + '</div>';
          postsHtml += '</div>';
        });
        
        document.getElementById('postsList').innerHTML = postsHtml || '<p>ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      });
    }

    // ê²Œì‹œê¸€ ì‘ì„± í•¨ìˆ˜
    function submitPost() {
      const content = document.getElementById('postContent').value.trim();
      if (!content) {
        alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      db.ref('users/' + auth.currentUser.uid + '/robloxNickname').once('value').then(snap => {
        const nickname = snap.val() || 'ìµëª…';
        const now = Date.now();
        
        db.ref('posts').push({
          content: content,
          nickname: nickname,
          timestamp: now,
          timeStr: new Date(now).toLocaleString()
        }).then(() => {
          document.getElementById('postContent').value = '';
        });
      });
    }

    // ê´€ë¦¬ììš© ì•„ì´í…œ ê´€ë¦¬ íŒ¨ë„
    function showAdminInventoryManagement() {
      if (!auth.currentUser || auth.currentUser.uid !== ADMIN_UID) {
        document.getElementById('formContainer').innerHTML = '<div style="color:red">ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>';
        return;
      }
      
      db.ref('users').once('value').then(snap => {
        const users = snap.val() || {};
        let html = '<h2>ê´€ë¦¬ì ì•„ì´í…œ ê´€ë¦¬</h2>';
        html += '<input type="text" id="inventoryMemberSearchInput" placeholder="ë‹‰ë„¤ì„ ê²€ìƒ‰..." style="width:60%;padding:8px 12px;margin-bottom:12px;border-radius:8px;border:1.5px solid #232428;background:#18191c;color:#fff;font-size:1rem;outline:none;">';
        html += '<table id="inventoryMembersTable" style="width:100%;background:#232428;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px #18191c;font-size:16px;color:#e3e3e3;">';
        html += '<tr><th>ë‹‰ë„¤ì„</th><th>í˜„ì¬ ì•„ì´í…œ</th><th>ì•„ì´í…œ ì¶”ê°€</th><th>ê´€ë¦¬</th></tr>';
        
        for (const uid in users) {
          const user = users[uid];
          const inventory = user.inventory || [];
          const inventoryText = inventory.length > 0 ? inventory.join(', ') : 'ì—†ìŒ';
          
          html += '<tr data-nick="' + (user.robloxNickname || '') + '">';
          html += '<td>' + (user.robloxNickname || '-') + '</td>';
          html += '<td id="inventory-' + uid + '">';
          if (inventory.length > 0) {
            inventory.forEach((item, index) => {
              html += '<span style="display:inline-block;background:#333;padding:2px 6px;margin:2px;border-radius:4px;font-size:12px;">';
              html += item + ' <button onclick="removeItem(\'' + uid + '\', \'' + index + '\')" style="background:none;border:none;color:#f44336;cursor:pointer;font-size:12px;margin-left:4px;">Ã—</button>';
              html += '</span>';
            });
          } else {
            html += 'ì—†ìŒ';
          }
          html += '</td>';
          html += '<td>';
          html += '<select id="newItemType-' + uid + '" style="width:120px;padding:4px 8px;margin-right:5px;border-radius:4px;border:1px solid #333;background:#18191c;color:#fff;font-size:14px;">';
          html += '<option value="custom">ì§ì ‘ ì…ë ¥</option>';
          html += '<option value="[ì„œë²„ì¶”ê°€]">[ì„œë²„ì¶”ê°€]</option>';
          html += '<option value="[VIP]">[VIP]</option>';
          html += '<option value="[VIP+]">[VIP+]</option>';
          html += '<option value="[MVP]">[MVP]</option>';
          html += '<option value="[MVP+]">[MVP+]</option>';
          html += '</select>';
          html += '<input type="text" id="newItem-' + uid + '" placeholder="ìƒˆ ì•„ì´í…œ" style="width:120px;padding:4px 8px;margin-right:5px;border-radius:4px;border:1px solid #333;background:#18191c;color:#fff;font-size:14px;">';
          html += '<button class="addItemBtn" data-uid="' + uid + '" style="padding:4px 8px;background:#4caf50;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">ì¶”ê°€</button>';
          html += '</td>';
          html += '<td>';
          html += '<button class="clearInventoryBtn" data-uid="' + uid + '" style="padding:4px 8px;background:#f44336;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">ì „ì²´ ì‚­ì œ</button>';
          html += '</td>';
          html += '</tr>';
        }
        html += '</table>';
        
        document.getElementById('formContainer').innerHTML = html;
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        setTimeout(() => {
          // ê²€ìƒ‰ ê¸°ëŠ¥
          const input = document.getElementById('inventoryMemberSearchInput');
          if (input) {
            input.addEventListener('input', function() {
              const v = this.value.trim().toLowerCase();
              document.querySelectorAll('#inventoryMembersTable tr[data-nick]').forEach(tr => {
                const nick = tr.getAttribute('data-nick').toLowerCase();
                tr.style.display = nick.includes(v) ? '' : 'none';
              });
            });
          }
          
          // ì•„ì´í…œ ì¶”ê°€ ë²„íŠ¼
          document.querySelectorAll('.addItemBtn').forEach(btn => {
            btn.onclick = function() {
              const uid = btn.getAttribute('data-uid');
              const select = document.getElementById('newItemType-' + uid);
              const input = document.getElementById('newItem-' + uid);
              const selectedType = select.value;
              const customItem = input.value.trim();
              
              let newItem = '';
              if (selectedType === 'custom') {
                newItem = customItem;
                if (!newItem) {
                  alert('ì•„ì´í…œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                  return;
                }
              } else {
                newItem = selectedType;
              }
              
              db.ref('users/' + uid + '/inventory').once('value').then(snap => {
                const currentInventory = snap.val() || [];
                if (currentInventory.includes(newItem)) {
                  alert('ì´ë¯¸ ë³´ìœ í•œ ì•„ì´í…œì…ë‹ˆë‹¤.');
                  return;
                }
                
                const updatedInventory = [...currentInventory, newItem];
                db.ref('users/' + uid + '/inventory').set(updatedInventory).then(() => {
                  input.value = '';
                  select.value = 'custom';
                  alert('ì•„ì´í…œì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                  showAdminInventoryManagement(); // ìƒˆë¡œê³ ì¹¨
                });
              });
            };
          });
          
          // ì¸ë²¤í† ë¦¬ ì „ì²´ ì‚­ì œ ë²„íŠ¼
          document.querySelectorAll('.clearInventoryBtn').forEach(btn => {
            btn.onclick = function() {
              const uid = btn.getAttribute('data-uid');
              if (confirm('ì´ ì‚¬ìš©ìì˜ ëª¨ë“  ì•„ì´í…œì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                db.ref('users/' + uid + '/inventory').set([]).then(() => {
                  alert('ì¸ë²¤í† ë¦¬ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                  showAdminInventoryManagement(); // ìƒˆë¡œê³ ì¹¨
                });
              }
            };
          });
        }, 100);
      });
    }

    // ê°œë³„ ì•„ì´í…œ ì‚­ì œ í•¨ìˆ˜
    function removeItem(uid, itemIndex) {
      if (confirm('ì´ ì•„ì´í…œì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        db.ref('users/' + uid + '/inventory').once('value').then(snap => {
          const inventory = snap.val() || [];
          inventory.splice(itemIndex, 1);
          db.ref('users/' + uid + '/inventory').set(inventory).then(() => {
            alert('ì•„ì´í…œì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            showAdminInventoryManagement(); // ìƒˆë¡œê³ ì¹¨
          });
        });
      }
    }

    // ì„œë²„ ì•„ì´í…œ ì‚¬ìš© í•¨ìˆ˜
    function useServerItem(itemName, itemIndex) {
      if (!auth.currentUser) {
        alert('ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
      }

      // ì•„ì´í…œëª…ì— ë”°ë¥¸ ì²˜ë¦¬
      if (itemName === '[ì„œë²„ì¶”ê°€]') {
        // ì„œë²„ ì¶”ê°€ ì•„ì´í…œ ì‚¬ìš©
        if (confirm('[ì„œë²„ì¶”ê°€] ì•„ì´í…œì„ ì‚¬ìš©í•˜ì—¬ ì¶”ê°€ ì„œë²„ë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          db.ref('users/' + auth.currentUser.uid + '/inventory').once('value').then(snap => {
            const inventory = snap.val() || [];
            inventory.splice(itemIndex, 1);
            
            // ì¸ë²¤í† ë¦¬ ì—…ë°ì´íŠ¸
            db.ref('users/' + auth.currentUser.uid).update({
              inventory: inventory
            }).then(() => {
              alert('[ì„œë²„ì¶”ê°€] ì•„ì´í…œì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤! ì´ì œ ì¶”ê°€ ì„œë²„ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
              showInventoryPanel(); // ì¸ë²¤í† ë¦¬ íŒ¨ë„ ìƒˆë¡œê³ ì¹¨
            }).catch(error => {
              alert('ì•„ì´í…œ ì‚¬ìš© ì‹¤íŒ¨: ' + error.message);
            });
          });
        }
      } else if (['[VIP]', '[VIP+]', '[MVP]', '[MVP+]'].includes(itemName)) {
        // í”„ë¦¬ë¯¸ì—„ ë“±ê¸‰ ì•„ì´í…œ ì‚¬ìš©
        const premiumGrade = itemName.replace(/[\[\]]/g, ''); // ëŒ€ê´„í˜¸ ì œê±°
        
        if (confirm(itemName + ' ì•„ì´í…œì„ ì‚¬ìš©í•˜ì—¬ ' + premiumGrade + ' ë“±ê¸‰ì„ ë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          // í˜„ì¬ ì¸ë²¤í† ë¦¬ì—ì„œ ì•„ì´í…œ ì œê±°
          db.ref('users/' + auth.currentUser.uid + '/inventory').once('value').then(snap => {
            const inventory = snap.val() || [];
            inventory.splice(itemIndex, 1);
            
            // ì¸ë²¤í† ë¦¬ ì—…ë°ì´íŠ¸ ë° í”„ë¦¬ë¯¸ì—„ ë“±ê¸‰ ì„¤ì •
            db.ref('users/' + auth.currentUser.uid).update({
              inventory: inventory,
              premium: premiumGrade
            }).then(() => {
              alert('ì•„ì´í…œì„ ì‚¬ìš©í•˜ì—¬ ' + premiumGrade + ' ë“±ê¸‰ì„ ë°›ì•˜ìŠµë‹ˆë‹¤!');
              showInventoryPanel(); // ì¸ë²¤í† ë¦¬ íŒ¨ë„ ìƒˆë¡œê³ ì¹¨
            }).catch(error => {
              alert('ì•„ì´í…œ ì‚¬ìš© ì‹¤íŒ¨: ' + error.message);
            });
          });
        }
      } else {
        alert('ì˜ëª»ëœ ì•„ì´í…œì…ë‹ˆë‹¤.');
        return;
      }
    }

    // ì¸ë²¤í† ë¦¬ íŒ¨ë„
    function showInventoryPanel() {
      if (!auth.currentUser) {
        document.getElementById('formContainer').innerHTML = '<div style="color:red">ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>';
        return;
      }
      
      db.ref('users/' + auth.currentUser.uid).once('value').then(snap => {
        const user = snap.val() || {};
        const inventory = user.inventory || [];
        
        let html = '<h2>ì¸ë²¤í† ë¦¬</h2>';
        html += '<div style="background:#232428;padding:20px;border-radius:10px;margin-bottom:20px;">';
        html += '<h3>ë³´ìœ  ì•„ì´í…œ</h3>';
        if (inventory.length > 0) {
          html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;">';
          inventory.forEach((item, index) => {
            const isServerItem = ['[ì„œë²„ì¶”ê°€]', '[VIP]', '[VIP+]', '[MVP]', '[MVP+]'].includes(item);
            html += '<div style="background:#333;padding:15px;border-radius:8px;border:1px solid #444;">';
            html += '<div style="font-weight:600;margin-bottom:8px;">' + item + '</div>';
            if (isServerItem) {
              html += '<button onclick="useServerItem(\'' + item + '\', ' + index + ')" style="width:100%;padding:8px;background:#4caf50;color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:600;">ì‚¬ìš©í•˜ê¸°</button>';
            } else {
              html += '<div style="color:#888;font-size:12px;">ì¼ë°˜ ì•„ì´í…œ</div>';
            }
            html += '</div>';
          });
          html += '</div>';
        } else {
          html += '<p>ë³´ìœ í•œ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
        html += '</div>';
        
        // ì„œë²„ ì¶”ê°€ ì•„ì´í…œ ì„¤ëª…
        html += '<div style="background:#232428;padding:20px;border-radius:10px;margin-bottom:20px;">';
        html += '<h3>ì„œë²„ ì¶”ê°€ ì•„ì´í…œ</h3>';
        html += '<div style="color:#e3e3e3;line-height:1.6;">';
        html += '<p><strong>[ì„œë²„ì¶”ê°€]:</strong> ì„œë²„ë¥¼ ì¶”ê°€ë¡œ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>';
        html += '<p><strong>[VIP]:</strong> VIP ë“±ê¸‰ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>';
        html += '<p><strong>[VIP+]:</strong> VIP+ ë“±ê¸‰ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>';
        html += '<p><strong>[MVP]:</strong> MVP ë“±ê¸‰ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>';
        html += '<p><strong>[MVP+]:</strong> MVP+ ë“±ê¸‰ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>';
        html += '</div>';
        html += '</div>';
        
        // ê´€ë¦¬ììš© ì•„ì´í…œ ê´€ë¦¬ íŒ¨ë„
        if (auth.currentUser.uid === ADMIN_UID) {
          html += '<div style="background:#232428;padding:20px;border-radius:10px;">';
          html += '<h3>ê´€ë¦¬ì ì•„ì´í…œ ê´€ë¦¬</h3>';
          html += '<p>ë‹¤ë¥¸ ë©¤ë²„ë“¤ì—ê²Œ ì•„ì´í…œì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>';
          html += '<button onclick="showAdminInventoryManagement()" style="margin-top:10px;padding:10px 20px;background:#ff9800;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;">ì•„ì´í…œ ê´€ë¦¬</button>';
          html += '</div>';
        }
        
        document.getElementById('formContainer').innerHTML = html;
      });
    }

    // ê´€ë¦¬ì ì„œë²„ ê´€ë¦¬ íŒ¨ë„
    function showAdminServerManagement() {
      if (!auth.currentUser || auth.currentUser.uid !== ADMIN_UID) {
        document.getElementById('formContainer').innerHTML = '<div style="color:red">ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>';
        return;
      }
      
      let html = '<h2>ì„œë²„ ê´€ë¦¬</h2>';
      html += '<input type="text" id="adminServerSearchInput" placeholder="ë‹‰ë„¤ì„/ì„œë²„ëª… ê²€ìƒ‰..." style="width:60%;padding:8px 12px;margin-bottom:12px;border-radius:8px;border:1.5px solid #232428;background:#18191c;color:#fff;font-size:1rem;outline:none;">';
      html += '<div id="adminServerTableContainer">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
      
      document.getElementById('formContainer').innerHTML = html;
      
      // ì‹¤ì‹œê°„ ì„œë²„ ê´€ë¦¬ í…Œì´ë¸” ì—…ë°ì´íŠ¸
      showRealtimeAdminServerTable();
    }

    // ì‹¤ì‹œê°„ ê´€ë¦¬ì ì„œë²„ í…Œì´ë¸” ì—…ë°ì´íŠ¸
    function showRealtimeAdminServerTable() {
      db.ref('users').on('value', function(snap) {
        const users = snap.val() || {};
        let html = '<table id="adminServerTable" style="width:100%;background:#232428;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px #18191c;font-size:16px;color:#e3e3e3;">';
        html += '<tr><th>ë‹‰ë„¤ì„</th><th>ìƒíƒœ</th><th>ìš”ì²­ì¼</th><th>ê´€ë¦¬</th></tr>';
        
        for (const uid in users) {
          const user = users[uid];
          if (!user.server) continue;
          
          let statusKor = '';
          switch (user.server.status) {
            case 'pending': statusKor = 'ëŒ€ê¸°ì¤‘'; break;
            case 'approved': statusKor = 'ìš´ì˜ì¤‘'; break;
            case 'stopped': statusKor = 'ì •ì§€ë¨'; break;
            case 'paused': statusKor = 'ì¼ì‹œì •ì§€'; break;
            default: statusKor = user.server.status;
          }
          
          html += '<tr data-nick="' + (user.robloxNickname || '') + '">';
          html += '<td>' + (user.robloxNickname || '-') + '</td>';
          html += '<td id="adminStatus-' + uid + '">' + statusKor + '</td>';
          html += '<td>' + (user.server.requestedAt ? new Date(user.server.requestedAt).toLocaleString() : '-') + '</td>';
          html += '<td>';
          
          if (user.server.status === 'pending') {
            html += '<button class="approveServerBtn" data-uid="' + uid + '">ìŠ¹ì¸</button> ';
            html += '<button class="rejectServerBtn" data-uid="' + uid + '">ê±°ì ˆ</button>';
          } else if (user.server.status === 'approved') {
            html += '<button class="stopServerBtn" data-uid="' + uid + '">ì •ì§€</button> ';
            html += '<button class="pauseServerBtn" data-uid="' + uid + '">ì¼ì‹œì •ì§€</button>';
          } else if (user.server.status === 'stopped') {
            html += '<button class="approveServerBtn" data-uid="' + uid + '">ì¬ìŠ¹ì¸</button>';
          } else if (user.server.status === 'paused') {
            html += '<button class="approveServerBtn" data-uid="' + uid + '">ì¬ê°œ</button> ';
            html += '<button class="stopServerBtn" data-uid="' + uid + '">ì •ì§€</button>';
          }
          
          // ëª¨ë“  ìƒíƒœì—ì„œ ì„œë²„ ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
          html += ' <button class="deleteServerBtn" data-uid="' + uid + '">ì‚­ì œ</button>';
          
          html += '</td>';
          html += '</tr>';
        }
        html += '</table>';
        
        const container = document.getElementById('adminServerTableContainer');
        if (container) {
          container.innerHTML = html;
          
          // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ë“±ë¡
          setupAdminServerEventListeners();
        }
      });
    }

    // ê´€ë¦¬ì ì„œë²„ ê´€ë¦¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    function setupAdminServerEventListeners() {
      // ê²€ìƒ‰ ê¸°ëŠ¥
      const input = document.getElementById('adminServerSearchInput');
      if (input) {
        input.addEventListener('input', function() {
          const v = this.value.trim().toLowerCase();
          document.querySelectorAll('#adminServerTable tr[data-nick]').forEach(tr => {
            const nick = tr.getAttribute('data-nick').toLowerCase();
            tr.style.display = nick.includes(v) ? '' : 'none';
          });
        });
      }
      
      // ì„œë²„ ìŠ¹ì¸ ë²„íŠ¼
      document.querySelectorAll('.approveServerBtn').forEach(btn => {
        btn.onclick = function() {
          const uid = btn.getAttribute('data-uid');
          const serverUrl = prompt('ì„œë²„ URLì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­):');
          
          const updateData = {
            status: 'approved',
            approvedAt: Date.now()
          };
          if (serverUrl) updateData.url = serverUrl;
          
          db.ref('users/' + uid + '/server').update(updateData).then(() => {
            alert('ì„œë²„ê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
          });
        };
      });
      
      // ì„œë²„ ê±°ì ˆ ë²„íŠ¼
      document.querySelectorAll('.rejectServerBtn').forEach(btn => {
        btn.onclick = function() {
          const uid = btn.getAttribute('data-uid');
          if (confirm('ì„œë²„ ìš”ì²­ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            db.ref('users/' + uid + '/server').remove().then(() => {
              alert('ì„œë²„ ìš”ì²­ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.');
            });
          }
        };
      });
      
      // ì„œë²„ ì •ì§€ ë²„íŠ¼
      document.querySelectorAll('.stopServerBtn').forEach(btn => {
        btn.onclick = function() {
          const uid = btn.getAttribute('data-uid');
          if (confirm('ì„œë²„ë¥¼ ì •ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            db.ref('users/' + uid + '/server/status').set('stopped').then(() => {
              alert('ì„œë²„ê°€ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            });
          }
        };
      });
      
      // ì„œë²„ ì¼ì‹œì •ì§€ ë²„íŠ¼
      document.querySelectorAll('.pauseServerBtn').forEach(btn => {
        btn.onclick = function() {
          const uid = btn.getAttribute('data-uid');
          if (confirm('ì„œë²„ë¥¼ ì¼ì‹œì •ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            db.ref('users/' + uid + '/server/status').set('paused').then(() => {
              alert('ì„œë²„ê°€ ì¼ì‹œì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            });
          }
        };
      });
      
      // ì„œë²„ ì‚­ì œ ë²„íŠ¼
      document.querySelectorAll('.deleteServerBtn').forEach(btn => {
        btn.onclick = function() {
          const uid = btn.getAttribute('data-uid');
          if (confirm('ì„œë²„ë¥¼ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
            db.ref('users/' + uid + '/server').remove().then(() => {
              alert('ì„œë²„ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            });
          }
        };
      });
    }

    // ë§Œë“¤ê¸° íŒ¨ë„ (ì„œë²„ ìƒì„±)
    function showCreatePanel() {
      if (!auth.currentUser) {
        document.getElementById('formContainer').innerHTML = '<div style="color:red">ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>';
        return;
      }
      
      db.ref('users/' + auth.currentUser.uid).once('value').then(snap => {
        const user = snap.val() || {};
        let html = '<h2>ì„œë²„ ë§Œë“¤ê¸°</h2>';
        
        if (user.server) {
          // ì´ë¯¸ ì„œë²„ê°€ ìˆëŠ” ê²½ìš°
          let statusKor = '';
          switch (user.server.status) {
            case 'pending': statusKor = 'ëŒ€ê¸°ì¤‘'; break;
            case 'approved': statusKor = 'ìš´ì˜ì¤‘'; break;
            case 'stopped': statusKor = 'ì •ì§€ë¨'; break;
            case 'paused': statusKor = 'ì¼ì‹œì •ì§€'; break;
            default: statusKor = user.server.status;
          }
          
          html += '<div style="background:#232428;padding:20px;border-radius:10px;margin-bottom:20px;">';
          html += '<h3>í˜„ì¬ ì„œë²„ ìƒíƒœ</h3>';
          html += '<p><strong>ì„œë²„ ì´ë¦„:</strong> ' + (user.server.name || '-') + '</p>';
          html += '<p><strong>ìƒíƒœ:</strong> ' + statusKor + '</p>';
          html += '<p><strong>ìƒì„±ì¼:</strong> ' + (user.server.requestedAt ? new Date(user.server.requestedAt).toLocaleString() : '-') + '</p>';
          if (user.server.description) {
            html += '<p><strong>ì„¤ëª…:</strong> ' + user.server.description + '</p>';
          }
          if (user.server.url) {
            html += '<p><strong>ì„œë²„ ì£¼ì†Œ:</strong> <a href="' + user.server.url + '" target="_blank" style="color:#2196f3;">' + user.server.url + '</a></p>';
          }
          html += '</div>';
          
          if (user.server.status === 'pending') {
            html += '<div style="background:#ff9800;padding:15px;border-radius:10px;margin-bottom:20px;">';
            html += '<p><strong>ì„œë²„ ìƒì„± ìš”ì²­ì´ ëŒ€ê¸°ì¤‘ì…ë‹ˆë‹¤.</strong></p>';
            html += '<p>ê´€ë¦¬ì ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>';
            html += '</div>';
          } else if (user.server.status === 'approved') {
            html += '<div style="background:#4caf50;padding:15px;border-radius:10px;margin-bottom:20px;">';
            html += '<p><strong>ì„œë²„ê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!</strong></p>';
            html += '<p>ì„œë²„ë¥¼ ìš´ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>';
            html += '</div>';
          } else if (user.server.status === 'paused') {
            html += '<div style="background:#ff9800;padding:15px;border-radius:10px;margin-bottom:20px;">';
            html += '<p><strong>ì„œë²„ê°€ ì¼ì‹œì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.</strong></p>';
            html += '<p>ì„œë²„ë¥¼ ë‹¤ì‹œ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>';
            html += '<button onclick="resumeServer()" style="margin-top:10px;padding:10px 20px;background:#4caf50;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;">ì„œë²„ ì¬ê°œ</button>';
            html += '</div>';
          } else if (user.server.status === 'stopped') {
            html += '<div style="background:#f44336;padding:15px;border-radius:10px;margin-bottom:20px;">';
            html += '<p><strong>ì„œë²„ê°€ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.</strong></p>';
            html += '<p>ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.</p>';
            html += '</div>';
          }
        } else {
          // ì„œë²„ê°€ ì—†ëŠ” ê²½ìš°
          html += '<div style="background:#232428;padding:20px;border-radius:10px;margin-bottom:20px;">';
          html += '<h3>ìƒˆ ì„œë²„ ìƒì„±</h3>';
          html += '<p>ë¡œë¸”ë¡ìŠ¤ ì„œë²„ë¥¼ ìƒì„±í•˜ì—¬ ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜ í”Œë ˆì´í•˜ì„¸ìš”!</p>';
          html += '<button onclick="showServerRequestForm()" style="margin-top:15px;padding:12px 24px;background:#d32c2c;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;">ì„œë²„ ìƒì„± ìš”ì²­</button>';
          html += '</div>';
          
          html += '<div style="background:#232428;padding:20px;border-radius:10px;">';
          html += '<h3>ì„œë²„ ìƒì„± ì•ˆë‚´</h3>';
          html += '<ul style="color:#e3e3e3;line-height:1.6;">';
          html += '<li>ì„œë²„ ìƒì„± ìš”ì²­ í›„ ê´€ë¦¬ì ìŠ¹ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</li>';
          html += '<li>ìŠ¹ì¸ë˜ë©´ ì„œë²„ ì£¼ì†Œê°€ ì œê³µë©ë‹ˆë‹¤</li>';
          html += '<li>ì„œë²„ëŠ” 24ì‹œê°„ ìš´ì˜ë©ë‹ˆë‹¤</li>';
          html += '<li>ê·œì¹™ì„ ìœ„ë°˜í•˜ë©´ ì„œë²„ê°€ ì •ì§€ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>';
          html += '</ul>';
          html += '</div>';
        }
        
        document.getElementById('formContainer').innerHTML = html;
      });
    }

    // ë©¤ë²„ ëª©ë¡ íŒ¨ë„ (ê´€ë¦¬ìë§Œ)
    function showMembersPanel() {
      if (!auth.currentUser || auth.currentUser.uid !== ADMIN_UID) {
        document.getElementById('formContainer').innerHTML = '<div style="color:red">ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>';
        return;
      }
      
      db.ref('users').once('value').then(snap => {
        const users = snap.val() || {};
        let html = '<h2>ì „ì²´ ë©¤ë²„ ëª©ë¡</h2>';
        html += '<input type="text" id="memberSearchInput" placeholder="ë‹‰ë„¤ì„ ê²€ìƒ‰..." style="width:60%;padding:8px 12px;margin-bottom:12px;border-radius:8px;border:1.5px solid #232428;background:#18191c;color:#fff;font-size:1rem;outline:none;">';
        html += '<table id="membersTable" style="width:100%;background:#232428;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px #18191c;font-size:16px;color:#e3e3e3;">';
        html += '<tr><th>ë‹‰ë„¤ì„</th><th>ê°€ì…ì¼</th><th>í”„ë¦¬ë¯¸ì—„</th><th>ì„œë²„</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr>';
        
        for (const uid in users) {
          const user = users[uid];
          const isBlocked = user.blocked || false;
          const isIpBlocked = user.ipBlocked || false;
          let statusText = 'ì •ìƒ';
          if (isIpBlocked) statusText = 'IPì°¨ë‹¨';
          else if (isBlocked) statusText = 'ì°¨ë‹¨';
          
          html += '<tr data-nick="' + (user.robloxNickname || '') + '">';
          html += '<td>' + (user.robloxNickname || '-') + '</td>';
          html += '<td>' + (user.createdAt ? new Date(user.createdAt).toLocaleString() : '-') + '</td>';
          html += '<td>' + (user.premium || '-') + '</td>';
          let serverStatusText = '-';
          if (user.server) {
            switch (user.server.status) {
              case 'pending': serverStatusText = 'ëŒ€ê¸°ì¤‘'; break;
              case 'approved': serverStatusText = 'ìš´ì˜ì¤‘'; break;
              case 'stopped': serverStatusText = 'ì •ì§€ë¨'; break;
              case 'paused': serverStatusText = 'ì¼ì‹œì •ì§€'; break;
              default: serverStatusText = user.server.status || '-';
            }
          }
          html += '<td>' + serverStatusText + '</td>';
          html += '<td id="status-' + uid + '">' + statusText + '</td>';
          html += '<td>';
          html += '<button class="blockBtn" data-uid="' + uid + '" data-action="' + (isBlocked ? 'unblock' : 'block') + '">' + (isBlocked ? 'ì°¨ë‹¨í•´ì œ' : 'ì°¨ë‹¨') + '</button> ';
          html += '<button class="ipBlockBtn" data-uid="' + uid + '" data-action="' + (isIpBlocked ? 'unipblock' : 'ipblock') + '">' + (isIpBlocked ? 'IPì°¨ë‹¨í•´ì œ' : 'IPì°¨ë‹¨') + '</button>';
          html += '</td>';
          html += '</tr>';
        }
        html += '</table>';
        
        document.getElementById('formContainer').innerHTML = html;
        
        // ê²€ìƒ‰ ê¸°ëŠ¥
        setTimeout(() => {
          const input = document.getElementById('memberSearchInput');
          if (input) {
            input.addEventListener('input', function() {
              const v = this.value.trim().toLowerCase();
              document.querySelectorAll('#membersTable tr[data-nick]').forEach(tr => {
                const nick = tr.getAttribute('data-nick').toLowerCase();
                tr.style.display = nick.includes(v) ? '' : 'none';
              });
            });
          }
          
          // ì°¨ë‹¨ ë²„íŠ¼ ì´ë²¤íŠ¸
          document.querySelectorAll('.blockBtn').forEach(btn => {
            btn.onclick = function() {
              const uid = btn.getAttribute('data-uid');
              const action = btn.getAttribute('data-action');
              const isBlock = action === 'block';
              
              if (confirm((isBlock ? 'ì°¨ë‹¨' : 'ì°¨ë‹¨í•´ì œ') + 'í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                db.ref('users/' + uid + '/blocked').set(isBlock ? true : null).then(() => {
                  btn.textContent = isBlock ? 'ì°¨ë‹¨í•´ì œ' : 'ì°¨ë‹¨';
                  btn.setAttribute('data-action', isBlock ? 'unblock' : 'block');
                  document.getElementById('status-' + uid).textContent = isBlock ? 'ì°¨ë‹¨' : 'ì •ìƒ';
                  alert((isBlock ? 'ì°¨ë‹¨' : 'ì°¨ë‹¨í•´ì œ') + ' ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                });
              }
            };
          });
          
          // IPì°¨ë‹¨ ë²„íŠ¼ ì´ë²¤íŠ¸
          document.querySelectorAll('.ipBlockBtn').forEach(btn => {
            btn.onclick = function() {
              const uid = btn.getAttribute('data-uid');
              const action = btn.getAttribute('data-action');
              const isIpBlock = action === 'ipblock';
              
              if (confirm((isIpBlock ? 'IPì°¨ë‹¨' : 'IPì°¨ë‹¨í•´ì œ') + 'í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                db.ref('users/' + uid + '/ipBlocked').set(isIpBlock ? true : null).then(() => {
                  btn.textContent = isIpBlock ? 'IPì°¨ë‹¨í•´ì œ' : 'IPì°¨ë‹¨';
                  btn.setAttribute('data-action', isIpBlock ? 'unipblock' : 'ipblock');
                  document.getElementById('status-' + uid).textContent = isIpBlock ? 'IPì°¨ë‹¨' : 'ì •ìƒ';
                  alert((isIpBlock ? 'IPì°¨ë‹¨' : 'IPì°¨ë‹¨í•´ì œ') + ' ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                });
              }
            };
          });
        }, 100);
      });
    }

    // ëª¨ë“  ë²„íŠ¼/ì´ë²¤íŠ¸ ë“±ë¡ì€ DOMContentLoaded ì´í›„ì—ë§Œ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('closeModal').onclick = closeModal;
      document.getElementById('modalBg').onclick = function(e) {
        if (e.target === this) closeModal();
      };
      var navHomeBtn = document.getElementById('navHomeBtn');
      if (navHomeBtn) navHomeBtn.addEventListener('click', function(e) {
        e.preventDefault();
        showHomePanel();
      });
      var navServerChartBtn = document.getElementById('navServerChartBtn');
      if (navServerChartBtn) navServerChartBtn.addEventListener('click', function(e) {
        e.preventDefault();
        showServerChart();
      });
      var navCommBtn = document.getElementById('navCommunityBtn');
      if (navCommBtn) navCommBtn.addEventListener('click', function(e) {
        e.preventDefault();
        showCommunity();
      });
      var navCreateBtn = document.getElementById('navCreateBtn');
      if (navCreateBtn) navCreateBtn.addEventListener('click', function(e) {
        e.preventDefault();
        showCreatePanel();
      });
      var sidebarFriendsLink = document.getElementById('sidebarFriendsLink');
      if (sidebarFriendsLink) sidebarFriendsLink.addEventListener('click', function(e) {
        e.preventDefault();
        showFriendsPanel();
      });
      var sidebarMessageLink = document.getElementById('sidebarMessageLink');
      if (sidebarMessageLink) sidebarMessageLink.addEventListener('click', function(e) {
        e.preventDefault();
        showMessagePanel();
      });
      var sidebarPremiumLink = Array.from(document.querySelectorAll('.sidebar-link')).find(a => a.textContent.replace(/\s/g,'') === 'í”„ë¦¬ë¯¸ì—„');
      if (sidebarPremiumLink) sidebarPremiumLink.addEventListener('click', function(e) {
        e.preventDefault();
        showPremiumPanel();
      });
      var sidebarInventoryLink = Array.from(document.querySelectorAll('.sidebar-link')).find(a => a.textContent.replace(/\s/g,'') === 'ì¸ë²¤í† ë¦¬');
      if (sidebarInventoryLink) sidebarInventoryLink.addEventListener('click', function(e) {
        e.preventDefault();
        showInventoryPanel();
      });
      var sidebarProfileLink = document.getElementById('sidebarProfileLink');
      if (sidebarProfileLink) sidebarProfileLink.addEventListener('click', function(e) {
        e.preventDefault();
        showProfilePanel();
      });
      // ë¡œê·¸ì¸/íšŒì›ê°€ì… ë²„íŠ¼ ì´ë²¤íŠ¸
      document.getElementById('showLogin').onclick = function() {
        showLoginForm();
      };
      document.getElementById('showSignup').onclick = function() {
        showSignupForm();
      };
      document.getElementById('logoutBtn').onclick = function() {
        auth.signOut().then(() => {
          showHomePanel();
        });
      };

      // ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€
      auth.onAuthStateChanged(function(user) {
        var btn = document.getElementById('sidebarMembersBtn');
        if (!btn) return;
        if (user && user.uid === ADMIN_UID) {
          btn.style.display = '';
          btn.onclick = function() { showMembersPanel(); };
        } else {
          btn.style.display = 'none';
          btn.onclick = null;
        }
        
        // ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¥¸ UI ì—…ë°ì´íŠ¸
        if (user) {
          // ì°¨ë‹¨ ìƒíƒœ í™•ì¸
          db.ref('users/' + user.uid).once('value').then(snap => {
            const userData = snap.val() || {};
            if (userData.blocked || userData.ipBlocked) {
              showBlockedMessage(userData.robloxNickname);
              return;
            }
            
            document.getElementById('loginButtons').style.display = 'none';
            document.getElementById('userInfo').style.display = 'block';
            const nickname = userData.robloxNickname || 'ì‚¬ìš©ì';
            document.getElementById('userNickname').textContent = nickname;
            
            // ë¡œê·¸ì¸ ì‹œ ìë™ìœ¼ë¡œ í™ˆìœ¼ë¡œ ì´ë™
            setTimeout(() => {
              showHomePanel();
            }, 100);
          });
        } else {
          document.getElementById('loginButtons').style.display = 'block';
          document.getElementById('userInfo').style.display = 'none';
        }
      });
      
      // í˜ì´ì§€ ë¡œë“œ ì‹œ í™ˆ íŒ¨ë„ í‘œì‹œ
      showHomePanel();
    });
    // ì„œë²„ ì°¨íŠ¸(ì „ì²´ ì„œë²„ ëª©ë¡) í‘œì‹œ í•¨ìˆ˜

    function showServerChart() {
      // ì„œë²„ ì°¨íŠ¸ ê²€ìƒ‰ ì…ë ¥ ì¶”ê°€
      document.getElementById('formContainer').innerHTML = '<h2>ì„œë²„ ì°¨íŠ¸</h2>' +
        '<input type="text" id="serverSearchInput" placeholder="ë‹‰ë„¤ì„/ì„œë²„ ìƒíƒœ ê²€ìƒ‰..." style="width:60%;padding:8px 12px;margin-bottom:12px;border-radius:8px;border:1.5px solid #232428;background:#18191c;color:#fff;font-size:1rem;outline:none;">' +
        '<div id="serverChartList">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
      db.ref('users').once('value').then(snap => {
        const users = snap.val();
        let html = '<table id="serverChartTable" style="width:100%;background:#232428;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px #18191c;font-size:16px;color:#e3e3e3;">';
        html += '<tr><th>ë‹‰ë„¤ì„</th><th>ìƒíƒœ</th><th>ìƒì„±ì¼</th><th>ì°¸ì—¬</th></tr>';
        for (const uid in users) {
          const user = users[uid];
          if (!user.server) continue;
          let statusKor = '';
          switch (user.server.status) {
            case 'pending': statusKor = 'ëŒ€ê¸°ì¤‘'; break;
            case 'approved': statusKor = 'ìš´ì˜ì¤‘'; break;
            case 'stopped': statusKor = 'ì •ì§€ë¨'; break;
            case 'paused': statusKor = 'ì¼ì‹œì •ì§€'; break;
            default: statusKor = user.server.status;
          }
          let joinCell = '-';
          if (auth.currentUser && auth.currentUser.uid !== uid) {
            joinCell = `<span id="joinStatus-${uid}"></span> <button id="joinBtn-${uid}" data-uid="${uid}">ì°¸ì—¬ ì‹ ì²­</button>`;
          }
          html += '<tr data-nick="' + (user.robloxNickname || '') + '" data-status="' + statusKor + '">' +
            '<td>' + (user.robloxNickname || '-') + '</td>' +
            '<td>' + statusKor + '</td>' +
            '<td>' + (user.server.requestedAt ? new Date(user.server.requestedAt).toLocaleString() : '-') + '</td>' +
            '<td>' + joinCell + '</td>' +
            '</tr>';
        }
        html += '</table>';
        document.getElementById('serverChartList').innerHTML = html;
        // ê²€ìƒ‰ í•„í„°
        setTimeout(function() {
          var input = document.getElementById('serverSearchInput');
          if (input) {
            input.addEventListener('input', function() {
              const v = this.value.trim().toLowerCase();
              document.querySelectorAll('#serverChartTable tr[data-nick]').forEach(function(tr) {
                if (!v) {
                  tr.style.display = '';
                  return;
                }
                const nick = tr.getAttribute('data-nick').toLowerCase();
                const status = tr.getAttribute('data-status').toLowerCase();
                tr.style.display = (nick.includes(v) || status.includes(v)) ? '' : 'none';
              });
            });
            // ìµœì´ˆ ì§„ì… ì‹œ ëª¨ë‘ í‘œì‹œ
            document.querySelectorAll('#serverChartTable tr[data-nick]').forEach(function(tr) {
              tr.style.display = '';
            });
          }
        }, 100); // DOM ë Œë” í›„ ë°”ì¸ë”©
        // ì°¸ì—¬ ì‹ ì²­ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
        for (const uid in users) {
          if (!users[uid].server) continue;
          if (auth.currentUser && auth.currentUser.uid !== uid) {
            const btn = document.getElementById('joinBtn-' + uid);
            if (btn) {
              btn.onclick = function() {
                if (confirm('ì„œë²„ ì°¸ì—¬ë¥¼ ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                  db.ref('serverJoinRequests/' + uid + '/' + auth.currentUser.uid).set({
                    status: 'pending',
                    requestedAt: Date.now(),
                    requesterUid: auth.currentUser.uid
                  }).then(() => {
                    alert('ì„œë²„ ì°¸ì—¬ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                  });
                }
              };
              
              // ì°¸ì—¬ ìƒíƒœ ì‹¤ì‹œê°„ í‘œì‹œ
              db.ref('serverJoinRequests/' + uid + '/' + auth.currentUser.uid).on('value', function(snap) {
                const req = snap.val();
                if (!req) {
                  document.getElementById('joinStatus-' + uid).innerText = '';
                  btn.disabled = false;
                  btn.textContent = 'ì°¸ì—¬ ì‹ ì²­';
                } else if (req.status === 'pending') {
                  document.getElementById('joinStatus-' + uid).innerText = 'ì„œë²„ ì†Œìœ ì ìŠ¹ì¸ ëŒ€ê¸°';
                  btn.disabled = true;
                  btn.textContent = 'ì‹ ì²­ë¨';
                } else if (req.status === 'approved') {
                  // ì„œë²„ ì†Œìœ ìê°€ ìŠ¹ì¸í•˜ë©´ ì‚¬ì´íŠ¸ ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸°
                  db.ref('serverJoinApprovals/' + uid + '/' + auth.currentUser.uid).on('value', function(approvSnap) {
                    const approv = approvSnap.val();
                    if (approv && approv.status === 'approved') {
                      document.getElementById('joinStatus-' + uid).innerHTML = users[uid].server.url ? ('<a href="' + users[uid].server.url + '" target="_blank" style="color:#4caf50;">ì„œë²„ ì…ì¥</a>') : 'ì£¼ì†Œ ì—†ìŒ';
                      btn.style.display = 'none';
                    } else if (approv && approv.status === 'rejected') {
                      document.getElementById('joinStatus-' + uid).innerText = 'ì‚¬ì´íŠ¸ ê´€ë¦¬ì ê±°ì ˆ';
                      btn.style.display = 'none';
                    } else {
                      document.getElementById('joinStatus-' + uid).innerText = 'ì‚¬ì´íŠ¸ ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸°';
                      btn.style.display = 'none';
                    }
                  });
                } else if (req.status === 'rejected') {
                  document.getElementById('joinStatus-' + uid).innerText = 'ì„œë²„ ì†Œìœ ì ê±°ì ˆ';
                  btn.style.display = 'none';
                }
              });
            }
          }
        }

        // ì‚¬ì´íŠ¸ ê´€ë¦¬ììš© ì°¸ì—¬ ìŠ¹ì¸ ë° ì¶”ë°© ìŠ¹ì¸ì€ ë³„ë„ í•¨ìˆ˜ë¡œ ì²˜ë¦¬
      }); // End of db.ref('users').once('value').then
    } // End of showServerChart
  </script>
</body>
</html>
